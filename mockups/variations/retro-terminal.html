<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CC Orchestrator - RETRO TERMINAL</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <style>
    /* ============================================ */
    /* RETRO TERMINAL CRT AESTHETIC */
    /* ============================================ */

    * {
      box-sizing: border-box;
    }

    :root {
      --terminal-black: #0a0a0a;
      --phosphor-green: #33ff33;
      --dim-green: #1a8f1a;
      --amber-warning: #ffb000;
      --error-red: #ff3333;
      --glow-intensity: 0 0 10px;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--terminal-black);
      font-family: 'VT323', monospace;
      color: var(--phosphor-green);
      overflow: hidden;
      cursor: default;
    }

    /* CRT Screen curvature effect */
    .crt-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: var(--terminal-black);
      overflow: hidden;
    }

    /* CRT scanline overlay */
    .crt-container::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: repeating-linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.15),
        rgba(0, 0, 0, 0.15) 1px,
        transparent 1px,
        transparent 2px
      );
      pointer-events: none;
      z-index: 1000;
      animation: scanline-flicker 0.1s infinite alternate;
    }

    /* Subtle screen curvature on main container */
    .crt-screen {
      width: 100%;
      height: 100%;
      border-radius: 2% / 1%;
      box-shadow:
        inset 0 0 100px rgba(0, 0, 0, 0.8),
        inset 0 0 20px rgba(51, 255, 51, 0.1);
    }

    /* Phosphor glow effect on all text */
    .phosphor-text {
      color: var(--phosphor-green);
      text-shadow: var(--glow-intensity) var(--phosphor-green);
      font-family: 'VT323', monospace;
      letter-spacing: 1px;
    }

    .phosphor-amber {
      color: var(--amber-warning);
      text-shadow: var(--glow-intensity) var(--amber-warning);
    }

    .phosphor-dim {
      color: var(--dim-green);
      text-shadow: var(--glow-intensity) var(--dim-green);
    }

    .phosphor-error {
      color: var(--error-red);
      text-shadow: var(--glow-intensity) var(--error-red);
    }

    /* Blinking cursor animation */
    @keyframes cursor-blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    .cursor-blink {
      animation: cursor-blink 1s infinite;
    }

    /* Scanline flicker */
    @keyframes scanline-flicker {
      0% { opacity: 0.95; }
      100% { opacity: 1; }
    }

    /* Occasional screen flicker */
    @keyframes screen-flicker {
      0%, 98% { opacity: 1; }
      99% { opacity: 0.8; }
      100% { opacity: 1; }
    }

    .screen-flicker {
      animation: screen-flicker 8s infinite;
    }

    /* Typewriter effect */
    @keyframes typewriter {
      from { width: 0; }
      to { width: 100%; }
    }

    /* ASCII box borders */
    .ascii-box {
      border: 1px solid var(--phosphor-green);
      padding: 0;
    }

    .ascii-box-dim {
      border: 1px solid var(--dim-green);
    }

    /* No rounded corners - everything angular */
    * {
      border-radius: 0 !important;
    }

    /* Status indicators as ASCII */
    .status-indicator {
      font-family: 'VT323', monospace;
      font-size: 20px;
      text-shadow: var(--glow-intensity) currentColor;
    }

    /* Minimal spacing - terminal aesthetic */
    .terminal-spacing {
      line-height: 1.2;
    }

    /* Enhanced entrance animation with CRT boot effect */
    @keyframes crt-boot {
      0% {
        opacity: 0;
        transform: scaleY(0.01) scaleX(1);
      }
      50% {
        opacity: 0.5;
        transform: scaleY(0.5) scaleX(1);
      }
      100% {
        opacity: 1;
        transform: scaleY(1) scaleX(1);
      }
    }

    .boot-animation {
      animation: crt-boot 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    /* Fade in for staggered elements */
    @keyframes fade-in {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .animate-in {
      animation: fade-in 0.3s ease-out forwards;
      opacity: 0;
    }

    .delay-1 { animation-delay: 0.1s; }
    .delay-2 { animation-delay: 0.2s; }
    .delay-3 { animation-delay: 0.3s; }
    .delay-4 { animation-delay: 0.4s; }
    .delay-5 { animation-delay: 0.5s; }

    /* Hover effects - minimal, terminal-style */
    .hover-highlight {
      transition: background-color 0.1s ease;
    }

    .hover-highlight:hover {
      background-color: rgba(51, 255, 51, 0.1);
    }

    /* Button styles - terminal aesthetic */
    button {
      background: transparent;
      border: 1px solid var(--phosphor-green);
      color: var(--phosphor-green);
      font-family: 'VT323', monospace;
      font-size: 18px;
      padding: 8px 16px;
      cursor: pointer;
      text-shadow: var(--glow-intensity) var(--phosphor-green);
      transition: all 0.1s ease;
    }

    button:hover {
      background: rgba(51, 255, 51, 0.1);
      box-shadow: var(--glow-intensity) var(--phosphor-green);
    }

    button:active {
      background: rgba(51, 255, 51, 0.2);
    }

    /* Input styles */
    input {
      background: var(--terminal-black);
      border: 1px solid var(--phosphor-green);
      color: var(--phosphor-green);
      font-family: 'VT323', monospace;
      font-size: 18px;
      padding: 4px 8px;
      text-shadow: var(--glow-intensity) var(--phosphor-green);
      outline: none;
    }

    input:focus {
      box-shadow: var(--glow-intensity) var(--phosphor-green);
    }

    /* Scrollbar styling - terminal theme */
    ::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }

    ::-webkit-scrollbar-track {
      background: var(--terminal-black);
      border: 1px solid var(--dim-green);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--dim-green);
      border: 1px solid var(--phosphor-green);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--phosphor-green);
    }

    /* Close animation */
    @keyframes terminal-close {
      from { opacity: 1; }
      to { opacity: 0; transform: scaleX(0); }
    }

    .animate-out {
      animation: terminal-close 0.2s ease-in forwards;
    }

    /* Overlay for modals */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 50;
    }

    /* Static noise effect (subtle) */
    @keyframes static-noise {
      0% { transform: translate(0, 0); }
      10% { transform: translate(-1px, 1px); }
      20% { transform: translate(1px, -1px); }
      30% { transform: translate(-1px, -1px); }
      40% { transform: translate(1px, 1px); }
      50% { transform: translate(0, 0); }
      60% { transform: translate(-1px, 1px); }
      70% { transform: translate(1px, -1px); }
      80% { transform: translate(-1px, -1px); }
      90% { transform: translate(1px, 1px); }
      100% { transform: translate(0, 0); }
    }

    .static-noise {
      animation: static-noise 0.1s infinite;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Mock data for instances
    const mockInstances = [
      {
        id: '1',
        name: 'AUTH-REFACTOR',
        status: 'working',
        pinned: true,
        workingDir: '~/PROJECTS/WEBAPP/SRC/AUTH',
        lastOutput: [
          '$ CLAUDE',
          '> REFACTORING AUTHENTICATION MIDDLEWARE...',
          '> READING SRC/MIDDLEWARE/AUTH.TS',
          '> ANALYZING TOKEN VALIDATION LOGIC... █',
        ]
      },
      {
        id: '2',
        name: 'API-TESTS',
        status: 'awaiting',
        pinned: false,
        workingDir: '~/PROJECTS/WEBAPP/TESTS',
        lastOutput: [
          '$ CLAUDE',
          '> 12 NEW TEST CASES CREATED FOR API ENDPOINTS',
          '> RUN TESTS NOW? [Y/N]',
          '> █',
        ]
      },
      {
        id: '3',
        name: 'DOCS-UPDATE',
        status: 'idle',
        pinned: false,
        workingDir: '~/PROJECTS/WEBAPP/DOCS',
        lastOutput: [
          '$ CLAUDE',
          '> DOCUMENTATION UPDATED SUCCESSFULLY',
          '> ',
          '$ _',
        ]
      },
      {
        id: '4',
        name: 'BUG-FIX-CART',
        status: 'error',
        pinned: true,
        workingDir: '~/PROJECTS/WEBAPP/SRC/CART',
        lastOutput: [
          '$ CLAUDE',
          '> ATTEMPTING TO FIX CART CALCULATION...',
          '> ERROR: CANNOT READ PROPERTY "PRICE" OF UNDEFINED',
          '> STACK TRACE: ...',
        ]
      },
      {
        id: '5',
        name: 'FEATURE-SEARCH',
        status: 'working',
        pinned: false,
        workingDir: '~/PROJECTS/WEBAPP/SRC/SEARCH',
        lastOutput: [
          '$ CLAUDE',
          '> IMPLEMENTING FUZZY SEARCH ALGORITHM...',
          '> WRITING SRC/SEARCH/FUZZY.TS',
          '> █',
        ]
      },
    ];

    // ASCII status indicators
    const getStatusChar = (status) => {
      switch(status) {
        case 'working': return '[*]';
        case 'awaiting': return '[?]';
        case 'idle': return '[-]';
        case 'error': return '[!]';
        default: return '[ ]';
      }
    };

    const getStatusColor = (status) => {
      switch(status) {
        case 'working': return 'phosphor-text';
        case 'awaiting': return 'phosphor-amber';
        case 'idle': return 'phosphor-dim';
        case 'error': return 'phosphor-error';
        default: return 'phosphor-dim';
      }
    };

    // Status indicator component
    const StatusIndicator = ({ status }) => (
      <span className={`status-indicator ${getStatusColor(status)}`}>
        {getStatusChar(status)}
      </span>
    );

    // Pin icon (ASCII star)
    const PinIcon = ({ pinned, onClick }) => {
      const handleClick = (e) => {
        e.stopPropagation();
        onClick();
      };

      return (
        <button
          onClick={handleClick}
          style={{
            border: 'none',
            padding: '0 4px',
            fontSize: '20px',
            background: 'transparent'
          }}
          className={pinned ? 'phosphor-amber' : 'phosphor-dim'}
        >
          {pinned ? '★' : '☆'}
        </button>
      );
    };

    // Editable name component
    const EditableName = ({
      instance, isEditing, editingName,
      onStartEdit, onNameChange, onConfirm, onCancel
    }) => {
      const inputRef = React.useRef(null);

      useEffect(() => {
        if (isEditing && inputRef.current) {
          inputRef.current.focus();
          inputRef.current.select();
        }
      }, [isEditing]);

      const handleKeyDown = (e) => {
        if (e.key === 'Enter') { e.preventDefault(); onConfirm(); }
        if (e.key === 'Escape') { e.preventDefault(); onCancel(); }
      };

      if (isEditing) {
        return (
          <input
            ref={inputRef}
            type="text"
            value={editingName}
            onChange={(e) => onNameChange(e.target.value.toUpperCase())}
            onKeyDown={handleKeyDown}
            onBlur={onConfirm}
            onClick={(e) => e.stopPropagation()}
            maxLength={32}
            style={{ width: `${Math.max(editingName.length, 8)}ch` }}
          />
        );
      }

      return (
        <span
          onDoubleClick={(e) => { e.stopPropagation(); onStartEdit(); }}
          style={{ cursor: 'text' }}
          className="phosphor-text"
        >
          {instance.name}
        </span>
      );
    };

    // Close button (ASCII X)
    const CloseButton = ({ onClick }) => (
      <button
        onClick={(e) => { e.stopPropagation(); onClick(); }}
        style={{
          border: 'none',
          padding: '0 8px',
          fontSize: '20px',
          background: 'transparent'
        }}
        className="phosphor-error"
      >
        [X]
      </button>
    );

    // Confirmation dialog
    const ConfirmDialog = ({ isOpen, onConfirm, onCancel, instance }) => {
      if (!isOpen || !instance) return null;

      const getMessage = () => {
        if (instance.status === 'working') {
          return `"${instance.name}" IS CURRENTLY WORKING. CLOSE? [Y/N]`;
        }
        if (instance.status === 'awaiting') {
          return `"${instance.name}" IS AWAITING INPUT. CLOSE? [Y/N]`;
        }
        if (instance.status === 'error') {
          return `"${instance.name}" HAS AN ERROR. CLOSE? [Y/N]`;
        }
        if (instance.pinned) {
          return `"${instance.name}" IS PINNED. CLOSE? [Y/N]`;
        }
        return `CLOSE "${instance.name}"? [Y/N]`;
      };

      return (
        <div className="overlay" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
          <div className="ascii-box" style={{
            background: 'var(--terminal-black)',
            padding: '24px',
            maxWidth: '600px',
            margin: '20px'
          }}>
            <div className="phosphor-text" style={{ fontSize: '24px', marginBottom: '16px' }}>
              ┌─────────────────────────────┐
            </div>
            <div className="phosphor-text" style={{ fontSize: '20px', marginBottom: '16px' }}>
              │ CLOSE INSTANCE              │
            </div>
            <div className="phosphor-text" style={{ fontSize: '24px', marginBottom: '24px' }}>
              └─────────────────────────────┘
            </div>
            <div className="phosphor-amber" style={{ fontSize: '18px', marginBottom: '24px' }}>
              {getMessage()}
            </div>
            <div style={{ display: 'flex', gap: '16px', justifyContent: 'flex-end' }}>
              <button onClick={onCancel} className="phosphor-text">
                [N] CANCEL
              </button>
              <button onClick={onConfirm} className="phosphor-error">
                [Y] CLOSE
              </button>
            </div>
          </div>
        </div>
      );
    };

    // Empty state
    const EmptyState = () => (
      <div style={{
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        height: '100%',
        flexDirection: 'column',
        gap: '16px'
      }}>
        <div className="phosphor-dim" style={{ fontSize: '32px' }}>
          ┌───────────────┐
        </div>
        <div className="phosphor-dim" style={{ fontSize: '28px' }}>
          │ NO INSTANCES  │
        </div>
        <div className="phosphor-dim" style={{ fontSize: '32px' }}>
          └───────────────┘
        </div>
        <div className="phosphor-dim" style={{ fontSize: '18px' }}>
          PRESS [+] TO CREATE NEW INSTANCE
        </div>
      </div>
    );

    // Terminal preview
    const TerminalPreview = ({ output, compact = false }) => (
      <div className="ascii-box-dim" style={{
        padding: '8px',
        height: compact ? '80px' : '120px',
        overflow: 'hidden'
      }}>
        <div className="phosphor-dim terminal-spacing" style={{ fontSize: '16px' }}>
          {output.slice(compact ? -2 : -4).map((line, i) => (
            <div key={i}>{line}</div>
          ))}
        </div>
      </div>
    );

    // Tab bar layout
    const TabBarLayout = ({
      instances, activeId, onSelect, onTogglePin, onRequestClose,
      editingInstanceId, editingName, onStartEditing, onEditingNameChange,
      onConfirmRename, onCancelEditing
    }) => (
      <div className="ascii-box" style={{
        display: 'flex',
        alignItems: 'center',
        gap: '8px',
        padding: '8px',
        overflowX: 'auto',
        borderBottom: '1px solid var(--phosphor-green)'
      }}>
        {instances.map((instance, i) => (
          <div
            key={instance.id}
            onClick={() => onSelect(instance.id)}
            className={`hover-highlight animate-in delay-${i + 1} ${instance.isClosing ? 'animate-out' : ''}`}
            style={{
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              padding: '8px 12px',
              border: activeId === instance.id ? '1px solid var(--phosphor-green)' : '1px solid var(--dim-green)',
              background: activeId === instance.id ? 'rgba(51, 255, 51, 0.05)' : 'transparent',
              cursor: 'pointer',
              whiteSpace: 'nowrap',
              fontSize: '18px'
            }}
          >
            <StatusIndicator status={instance.status} />
            <EditableName
              instance={instance}
              isEditing={editingInstanceId === instance.id}
              editingName={editingName}
              onStartEdit={() => onStartEditing(instance.id, instance.name)}
              onNameChange={onEditingNameChange}
              onConfirm={() => onConfirmRename(instance.id)}
              onCancel={onCancelEditing}
            />
            <PinIcon
              pinned={instance.pinned}
              onClick={() => onTogglePin(instance.id)}
            />
            <CloseButton onClick={() => onRequestClose(instance)} />
          </div>
        ))}
        <button style={{ fontSize: '20px', padding: '8px 16px' }} className="phosphor-text">
          [+] NEW
        </button>
      </div>
    );

    // Card layout
    const CardLayout = ({
      instances, activeId, onSelect, onTogglePin, onRequestClose,
      editingInstanceId, editingName, onStartEditing, onEditingNameChange,
      onConfirmRename, onCancelEditing
    }) => (
      <div style={{
        display: 'grid',
        gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))',
        gap: '16px',
        padding: '16px'
      }}>
        {instances.map((instance, i) => (
          <div
            key={instance.id}
            onClick={() => onSelect(instance.id)}
            className={`ascii-box hover-highlight animate-in delay-${i + 1} ${instance.isClosing ? 'animate-out' : ''}`}
            style={{
              padding: '16px',
              cursor: 'pointer',
              background: activeId === instance.id ? 'rgba(51, 255, 51, 0.05)' : 'transparent',
              position: 'relative'
            }}
          >
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '20px' }}>
                <StatusIndicator status={instance.status} />
                <EditableName
                  instance={instance}
                  isEditing={editingInstanceId === instance.id}
                  editingName={editingName}
                  onStartEdit={() => onStartEditing(instance.id, instance.name)}
                  onNameChange={onEditingNameChange}
                  onConfirm={() => onConfirmRename(instance.id)}
                  onCancel={onCancelEditing}
                />
              </div>
              <div style={{ display: 'flex', gap: '4px' }}>
                <PinIcon
                  pinned={instance.pinned}
                  onClick={() => onTogglePin(instance.id)}
                />
                <CloseButton onClick={() => onRequestClose(instance)} />
              </div>
            </div>
            <div className="phosphor-dim" style={{ fontSize: '16px', marginBottom: '12px' }}>
              {instance.workingDir}
            </div>
            <TerminalPreview output={instance.lastOutput} compact />
          </div>
        ))}
        {/* Add new card */}
        <div className="ascii-box-dim hover-highlight" style={{
          padding: '16px',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          minHeight: '200px',
          cursor: 'pointer',
          flexDirection: 'column',
          gap: '12px'
        }}>
          <div className="phosphor-dim" style={{ fontSize: '32px' }}>[+]</div>
          <div className="phosphor-dim" style={{ fontSize: '18px' }}>NEW INSTANCE</div>
        </div>
      </div>
    );

    // List layout
    const ListLayout = ({
      instances, activeId, onSelect, onTogglePin, onRequestClose,
      editingInstanceId, editingName, onStartEditing, onEditingNameChange,
      onConfirmRename, onCancelEditing
    }) => (
      <div>
        {instances.map((instance, i) => (
          <div
            key={instance.id}
            onClick={() => onSelect(instance.id)}
            className={`hover-highlight animate-in delay-${i + 1} ${instance.isClosing ? 'animate-out' : ''}`}
            style={{
              display: 'flex',
              alignItems: 'center',
              gap: '16px',
              padding: '12px 16px',
              borderBottom: '1px solid var(--dim-green)',
              cursor: 'pointer',
              background: activeId === instance.id ? 'rgba(51, 255, 51, 0.05)' : 'transparent',
              fontSize: '18px'
            }}
          >
            <PinIcon
              pinned={instance.pinned}
              onClick={() => onTogglePin(instance.id)}
            />
            <StatusIndicator status={instance.status} />
            <div style={{ flex: 1, minWidth: 0 }}>
              <EditableName
                instance={instance}
                isEditing={editingInstanceId === instance.id}
                editingName={editingName}
                onStartEdit={() => onStartEditing(instance.id, instance.name)}
                onNameChange={onEditingNameChange}
                onConfirm={() => onConfirmRename(instance.id)}
                onCancel={onCancelEditing}
              />
              <div className="phosphor-dim" style={{ fontSize: '14px' }}>
                {instance.workingDir}
              </div>
            </div>
            <div className="phosphor-dim" style={{ fontSize: '16px', width: '300px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
              {instance.lastOutput[instance.lastOutput.length - 1]}
            </div>
            <CloseButton onClick={() => onRequestClose(instance)} />
          </div>
        ))}
      </div>
    );

    // Layout switcher
    const LayoutSwitcher = ({ layout, onChange }) => {
      const layouts = [
        { id: 'tabs', label: '[TABS]' },
        { id: 'cards', label: '[CARDS]' },
        { id: 'list', label: '[LIST]' },
      ];

      return (
        <div style={{ display: 'flex', gap: '8px' }}>
          {layouts.map(l => (
            <button
              key={l.id}
              onClick={() => onChange(l.id)}
              className={layout === l.id ? 'phosphor-text' : 'phosphor-dim'}
              style={{
                background: layout === l.id ? 'rgba(51, 255, 51, 0.1)' : 'transparent',
                fontSize: '18px'
              }}
            >
              {l.label}
            </button>
          ))}
        </div>
      );
    };

    // Main terminal view
    const TerminalView = ({ instance, editingInstanceId, editingName, onStartEditing, onEditingNameChange, onConfirmRename, onCancelEditing }) => (
      <div style={{ display: 'flex', flexDirection: 'column', flex: 1, overflow: 'hidden' }}>
        <div className="ascii-box" style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          padding: '12px 16px',
          borderBottom: '1px solid var(--phosphor-green)'
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '12px', fontSize: '20px' }}>
            <StatusIndicator status={instance.status} />
            <EditableName
              instance={instance}
              isEditing={editingInstanceId === instance.id}
              editingName={editingName}
              onStartEdit={() => onStartEditing(instance.id, instance.name)}
              onNameChange={onEditingNameChange}
              onConfirm={() => onConfirmRename(instance.id)}
              onCancel={onCancelEditing}
            />
          </div>
          <div className="phosphor-dim" style={{ fontSize: '16px' }}>
            {instance.workingDir}
          </div>
        </div>
        <div className="phosphor-text terminal-spacing" style={{
          flex: 1,
          padding: '16px',
          overflow: 'auto',
          fontSize: '18px'
        }}>
          {instance.lastOutput.map((line, i) => (
            <div key={i} style={{ paddingTop: '2px', paddingBottom: '2px' }}>
              {line}
            </div>
          ))}
          <div className="phosphor-dim" style={{ marginTop: '24px' }}>
            ───────────────────────────────────────────────
            <br/>
            [TERMINAL OUTPUT WOULD APPEAR HERE]
            <br/>
            THIS IS A MOCKUP PREVIEW OF THE TERMINAL
            <br/>
            ───────────────────────────────────────────────
          </div>
        </div>
      </div>
    );

    // Main App
    const App = () => {
      const [layout, setLayout] = useState('tabs');
      const [activeInstance, setActiveInstance] = useState('1');
      const [instances, setInstances] = useState(mockInstances);
      const [editingInstanceId, setEditingInstanceId] = useState(null);
      const [editingName, setEditingName] = useState('');
      const [closeConfirmation, setCloseConfirmation] = useState(null);

      // Validate instance name
      const validateName = (name) => {
        if (!name || name.length === 0) return false;
        if (name.length > 32) return false;
        return /^[A-Z0-9_-]+$/.test(name);
      };

      // Start editing
      const startEditing = (instanceId, currentName) => {
        setEditingInstanceId(instanceId);
        setEditingName(currentName);
      };

      // Cancel editing
      const cancelEditing = () => {
        setEditingInstanceId(null);
        setEditingName('');
      };

      // Confirm rename
      const confirmRename = (instanceId) => {
        const trimmedName = editingName.trim();
        if (validateName(trimmedName)) {
          setInstances(prev => prev.map(inst =>
            inst.id === instanceId ? { ...inst, name: trimmedName } : inst
          ));
        }
        cancelEditing();
      };

      // Toggle pin
      const togglePin = (instanceId) => {
        setInstances(prev => prev.map(instance =>
          instance.id === instanceId
            ? { ...instance, pinned: !instance.pinned }
            : instance
        ));
      };

      // Request close
      const requestClose = (instance) => {
        const needsConfirmation =
          instance.status === 'working' ||
          instance.status === 'awaiting' ||
          instance.status === 'error' ||
          instance.pinned;

        if (needsConfirmation) {
          setCloseConfirmation(instance);
        } else {
          handleCloseInstance(instance.id);
        }
      };

      // Handle close
      const handleCloseInstance = (instanceId) => {
        const instanceIndex = instances.findIndex(i => i.id === instanceId);
        const wasActive = activeInstance === instanceId;

        setInstances(prev => prev.map(i =>
          i.id === instanceId ? { ...i, isClosing: true } : i
        ));

        setTimeout(() => {
          setInstances(prev => {
            const remaining = prev.filter(i => i.id !== instanceId);

            if (wasActive && remaining.length > 0) {
              const newActiveIndex = Math.max(0, instanceIndex - 1);
              setActiveInstance(remaining[Math.min(newActiveIndex, remaining.length - 1)].id);
            } else if (remaining.length === 0) {
              setActiveInstance(null);
            }

            return remaining;
          });
        }, 200);
      };

      // Confirm close
      const confirmClose = () => {
        if (closeConfirmation) {
          handleCloseInstance(closeConfirmation.id);
          setCloseConfirmation(null);
        }
      };

      // Cancel close
      const cancelClose = () => {
        setCloseConfirmation(null);
      };

      // Sort instances
      const sortedInstances = [...instances].sort((a, b) => {
        if (a.pinned && !b.pinned) return -1;
        if (!a.pinned && b.pinned) return 1;
        return 0;
      });

      const activeInst = instances.find(i => i.id === activeInstance) || instances[0];

      return (
        <div className="crt-container screen-flicker">
          <div className="crt-screen" style={{ display: 'flex', flexDirection: 'column', height: '100vh' }}>
            {/* Header */}
            <header className="ascii-box boot-animation" style={{
              padding: '16px 24px',
              borderBottom: '2px solid var(--phosphor-green)'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                <div>
                  <div className="phosphor-text" style={{ fontSize: '32px', lineHeight: '1' }}>
                    ┌─────────────────────────────────┐
                  </div>
                  <div className="phosphor-text" style={{ fontSize: '28px', lineHeight: '1.2' }}>
                    │ <span className="phosphor-amber">CC</span> ORCHESTRATOR │ RETRO TERMINAL │
                  </div>
                  <div className="phosphor-text" style={{ fontSize: '32px', lineHeight: '1' }}>
                    └─────────────────────────────────┘
                  </div>
                  <div className="phosphor-dim" style={{ fontSize: '16px', marginTop: '8px' }}>
                    {instances.length} INSTANCE{instances.length !== 1 ? 'S' : ''} ACTIVE
                    {instances.filter(i => i.pinned).length > 0 && (
                      <span className="phosphor-amber" style={{ marginLeft: '16px' }}>
                        ({instances.filter(i => i.pinned).length} PINNED)
                      </span>
                    )}
                  </div>
                </div>
                <LayoutSwitcher layout={layout} onChange={setLayout} />
              </div>
            </header>

            {/* Main content */}
            <div style={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
              {instances.length === 0 ? (
                <EmptyState />
              ) : (
                <>
                  {layout === 'tabs' && (
                    <>
                      <TabBarLayout
                        instances={sortedInstances}
                        activeId={activeInstance}
                        onSelect={setActiveInstance}
                        onTogglePin={togglePin}
                        onRequestClose={requestClose}
                        editingInstanceId={editingInstanceId}
                        editingName={editingName}
                        onStartEditing={startEditing}
                        onEditingNameChange={setEditingName}
                        onConfirmRename={confirmRename}
                        onCancelEditing={cancelEditing}
                      />
                      {activeInst && (
                        <TerminalView
                          instance={activeInst}
                          editingInstanceId={editingInstanceId}
                          editingName={editingName}
                          onStartEditing={startEditing}
                          onEditingNameChange={setEditingName}
                          onConfirmRename={confirmRename}
                          onCancelEditing={cancelEditing}
                        />
                      )}
                    </>
                  )}
                  {layout === 'cards' && (
                    <div style={{ flex: 1, overflow: 'auto' }}>
                      <CardLayout
                        instances={sortedInstances}
                        activeId={activeInstance}
                        onSelect={setActiveInstance}
                        onTogglePin={togglePin}
                        onRequestClose={requestClose}
                        editingInstanceId={editingInstanceId}
                        editingName={editingName}
                        onStartEditing={startEditing}
                        onEditingNameChange={setEditingName}
                        onConfirmRename={confirmRename}
                        onCancelEditing={cancelEditing}
                      />
                    </div>
                  )}
                  {layout === 'list' && (
                    <div style={{ flex: 1, overflow: 'auto', display: 'flex', flexDirection: 'column' }}>
                      <ListLayout
                        instances={sortedInstances}
                        activeId={activeInstance}
                        onSelect={setActiveInstance}
                        onTogglePin={togglePin}
                        onRequestClose={requestClose}
                        editingInstanceId={editingInstanceId}
                        editingName={editingName}
                        onStartEditing={startEditing}
                        onEditingNameChange={setEditingName}
                        onConfirmRename={confirmRename}
                        onCancelEditing={cancelEditing}
                      />
                      {activeInst && (
                        <div style={{ borderTop: '1px solid var(--phosphor-green)' }}>
                          <TerminalView
                            instance={activeInst}
                            editingInstanceId={editingInstanceId}
                            editingName={editingName}
                            onStartEditing={startEditing}
                            onEditingNameChange={setEditingName}
                            onConfirmRename={confirmRename}
                            onCancelEditing={cancelEditing}
                          />
                        </div>
                      )}
                    </div>
                  )}
                </>
              )}
            </div>

            {/* Confirmation Dialog */}
            <ConfirmDialog
              isOpen={closeConfirmation !== null}
              instance={closeConfirmation}
              onConfirm={confirmClose}
              onCancel={cancelClose}
            />
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
