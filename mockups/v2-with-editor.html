<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Code Orchestrator - v2 with Markdown Editor</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['IBM Plex Sans', 'system-ui', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
          },
          colors: {
            surface: {
              900: 'var(--surface-900)',
              800: 'var(--surface-800)',
              700: 'var(--surface-700)',
              600: 'var(--surface-600)',
              500: 'var(--surface-500)',
            },
            theme: {
              primary: 'var(--text-primary)',
              secondary: 'var(--text-secondary)',
              muted: 'var(--text-muted)',
              dim: 'var(--text-dim)',
            },
            accent: {
              DEFAULT: '#f59e0b',
              bright: '#fbbf24',
              dim: '#d97706',
            },
            state: {
              working: '#06b6d4',
              awaiting: '#f59e0b',
              idle: '#6b7280',
              error: '#f43f5e',
            }
          }
        }
      }
    }
  </script>
  <style>
    :root {
      --surface-900: #f8fafc;
      --surface-800: #f1f5f9;
      --surface-700: #e2e8f0;
      --surface-600: #cbd5e1;
      --surface-500: #94a3b8;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --text-dim: #94a3b8;
      --border-color: #cbd5e1;
    }

    .dark {
      --surface-900: #0a0a0b;
      --surface-800: #121214;
      --surface-700: #1a1a1e;
      --surface-600: #232328;
      --surface-500: #2d2d33;
      --text-primary: #ffffff;
      --text-secondary: #d1d5db;
      --text-muted: #6b7280;
      --text-dim: #4b5563;
      --border-color: #232328;
    }

    * { box-sizing: border-box; }
    body {
      background: var(--surface-900);
      font-family: 'IBM Plex Sans', system-ui, sans-serif;
      color: var(--text-primary);
    }

    @keyframes revealUp {
      from { opacity: 0; transform: translateY(20px) scale(0.98); filter: blur(4px); }
      to { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
    }
    .animate-in {
      animation: revealUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      opacity: 0;
    }
    .delay-1 { animation-delay: 0.08s; }
    .delay-2 { animation-delay: 0.16s; }
    .delay-3 { animation-delay: 0.24s; }
    .delay-4 { animation-delay: 0.32s; }
    .delay-5 { animation-delay: 0.4s; }

    @keyframes pulse-glow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .pulse-working { animation: pulse-glow 2s ease-in-out infinite; }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .slide-in { animation: slideIn 0.3s ease-out forwards; }

    @keyframes expandIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .expand-in { animation: expandIn 0.2s ease-out forwards; }

    @keyframes slideOut {
      from { opacity: 1; transform: translateX(0) scale(1); }
      to { opacity: 0; transform: translateX(-12px) scale(0.95); }
    }
    .animate-out {
      animation: slideOut 0.25s ease-in forwards;
      pointer-events: none;
    }

    .terminal-text {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      line-height: 1.5;
    }

    .bg-atmosphere {
      background:
        radial-gradient(ellipse 80% 50% at 50% -20%, rgba(245, 158, 11, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse 60% 40% at 100% 100%, rgba(34, 211, 238, 0.1) 0%, transparent 40%),
        linear-gradient(180deg, var(--surface-800) 0%, var(--surface-900) 100%);
    }

    .active-glow {
      box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.6), 0 0 24px -4px rgba(245, 158, 11, 0.5);
    }

    .card-elevated {
      background: rgba(26, 26, 30, 0.8);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    :root .card-elevated {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(0, 0, 0, 0.08);
    }

    .terminal-glow {
      position: relative;
      overflow: visible;
    }
    .terminal-glow::after {
      content: '';
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 120px;
      background: linear-gradient(to top, rgba(34, 211, 238, 0.08) 0%, transparent 100%);
      pointer-events: none;
      z-index: 1;
    }

    .hover-lift { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .hover-lift:hover { transform: translateY(-2px); }
    .press-effect:active { transform: scale(0.97); }
    .hover-scale { transition: transform 0.15s ease; }
    .hover-scale:hover { transform: scale(1.08); }

    /* Editor styles */
    .editor-content {
      font-family: 'IBM Plex Sans', system-ui, sans-serif;
      font-size: 15px;
      line-height: 1.7;
    }
    .editor-content h1 { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; }
    .editor-content h2 { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; margin-top: 1rem; }
    .editor-content p { margin-bottom: 0.75rem; }
    .editor-content ul { list-style: disc; margin-left: 1.5rem; margin-bottom: 0.75rem; }
    .editor-content li { margin-bottom: 0.25rem; }
    .editor-content strong { font-weight: 600; }
    .editor-content code {
      background: var(--surface-700);
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.875em;
    }

    /* Resize handles */
    .resize-handle-h {
      width: 4px;
      cursor: col-resize;
      background: var(--surface-600);
      transition: background 0.2s;
    }
    .resize-handle-h:hover {
      background: var(--accent, #f59e0b);
    }
    .resize-handle-v {
      height: 4px;
      cursor: row-resize;
      background: var(--surface-600);
      transition: background 0.2s;
    }
    .resize-handle-v:hover {
      background: var(--accent, #f59e0b);
    }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--surface-700); }
    ::-webkit-scrollbar-thumb { background: var(--surface-500); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--surface-600); }
  </style>
</head>
<body class="bg-surface-900 text-theme-primary min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Status dot (defined early since it's used by many components)
    const StatusDot = ({ status, size = 'md' }) => {
      const sizeClasses = { sm: 'w-2 h-2', md: 'w-3 h-3', lg: 'w-4 h-4' };
      const colorClasses = {
        working: 'bg-state-working pulse-working',
        awaiting: 'bg-state-awaiting',
        idle: 'bg-state-idle',
        error: 'bg-state-error',
      };
      return <span className={`inline-block rounded-full ${sizeClasses[size]} ${colorClasses[status]}`} />;
    };

    // Status badge (defined early since it's used by many components)
    const StatusBadge = ({ status }) => {
      const labels = { working: 'Working', awaiting: 'Awaiting', idle: 'Idle', error: 'Error' };
      const bgClasses = {
        working: 'bg-state-working/20 text-state-working border-state-working/30',
        awaiting: 'bg-state-awaiting/20 text-state-awaiting border-state-awaiting/30',
        idle: 'bg-state-idle/20 text-state-idle border-state-idle/30',
        error: 'bg-state-error/20 text-state-error border-state-error/30',
      };
      return (
        <span className={`inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium border ${bgClasses[status]}`}>
          <StatusDot status={status} size="sm" />
          {labels[status]}
        </span>
      );
    };

    // ============ HOME PAGE COMPONENTS ============

    // Getting Started Banner (dismissible onboarding)
    const GettingStartedBanner = ({ visible, onDismiss }) => {
      if (!visible) return null;

      const steps = [
        { num: 1, title: 'Create an instance', desc: 'Click + to start a new terminal' },
        { num: 2, title: 'Navigate to project', desc: 'cd into your project directory' },
        { num: 3, title: 'Start Claude Code', desc: "Run 'claude' to begin coding" },
        { num: 4, title: 'Manage from here', desc: 'Pin, rename, and switch instances' },
      ];

      return (
        <div className="bg-accent/10 border border-accent/20 rounded-xl p-6 mb-6 animate-in">
          <div className="flex justify-between items-start mb-4">
            <h2 className="text-lg font-semibold text-theme-primary">Getting Started with CC Orchestrator</h2>
            <button
              onClick={onDismiss}
              className="text-theme-muted hover:text-theme-primary transition-colors p-1"
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M18 6L6 18M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
            {steps.map(step => (
              <div key={step.num} className="flex flex-col">
                <div className="flex items-center gap-2 mb-1">
                  <span className="text-accent font-bold">{step.num}.</span>
                  <span className="font-medium text-theme-primary">{step.title}</span>
                </div>
                <p className="text-sm text-theme-muted font-light">{step.desc}</p>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // Stat Cards (instance counts by status)
    const StatCards = ({ instances }) => {
      const stats = [
        { label: 'Total', value: instances.length, colorClass: 'text-accent border-accent/30' },
        { label: 'Working', value: instances.filter(i => i.status === 'working').length, colorClass: 'text-state-working border-state-working/30' },
        { label: 'Awaiting', value: instances.filter(i => i.status === 'awaiting').length, colorClass: 'text-state-awaiting border-state-awaiting/30' },
        { label: 'Errors', value: instances.filter(i => i.status === 'error').length, colorClass: 'text-state-error border-state-error/30' },
      ];

      return (
        <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          {stats.map((stat, i) => (
            <div
              key={stat.label}
              className={`animate-in delay-${i + 1} bg-surface-700 rounded-xl p-4 border ${stat.colorClass}`}
            >
              <div className={`text-5xl font-extrabold tracking-tight ${stat.colorClass.split(' ')[0]}`}>{stat.value}</div>
              <div className="text-sm text-theme-muted mt-1">{stat.label}</div>
            </div>
          ))}
        </div>
      );
    };

    // Quick Actions (buttons)
    const QuickActions = ({ onNewInstance, onViewAll }) => (
      <div className="flex gap-3 mb-6">
        <button
          onClick={onNewInstance}
          className="flex items-center gap-2 px-4 py-2 bg-accent text-surface-900 font-medium rounded-lg hover:bg-accent-bright transition-colors hover-lift press-effect"
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M12 5v14M5 12h14" />
          </svg>
          New Instance
        </button>
        <button
          onClick={onViewAll}
          className="flex items-center gap-2 px-4 py-2 bg-surface-700 text-theme-primary font-medium rounded-lg hover:bg-surface-600 transition-colors hover-lift press-effect"
        >
          View All
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M5 12h14M12 5l7 7-7 7" />
          </svg>
        </button>
      </div>
    );

    // Instance Row (shared by PinnedInstances and RecentInstances)
    const InstanceRow = ({ instance, onClick, showPin = false }) => (
      <div
        onClick={onClick}
        className="flex items-center gap-3 px-4 py-3 hover:bg-surface-600 cursor-pointer transition-colors rounded-lg"
      >
        <StatusDot status={instance.status} />
        {showPin && <span className="text-accent">★</span>}
        <span className="font-medium text-theme-primary flex-1">{instance.name}</span>
        <StatusBadge status={instance.status} />
        <span className="text-xs text-theme-muted font-mono font-light hidden sm:block">{instance.workingDir}</span>
      </div>
    );

    // Pinned Instances section
    const PinnedInstances = ({ instances, onSelectInstance }) => {
      const pinned = instances.filter(i => i.pinned);
      if (pinned.length === 0) return null;

      return (
        <div className="mb-6">
          <h3 className="flex items-center gap-2 text-xs font-medium tracking-widest uppercase text-theme-muted mb-3">
            <span className="text-accent">★</span> Pinned Instances
          </h3>
          <div className="bg-surface-700 rounded-xl overflow-hidden divide-y divide-surface-600">
            {pinned.map(instance => (
              <InstanceRow
                key={instance.id}
                instance={instance}
                onClick={() => onSelectInstance(instance.id)}
                showPin
              />
            ))}
          </div>
        </div>
      );
    };

    // Recent Instances section
    const RecentInstances = ({ instances, onSelectInstance }) => {
      const recent = instances.filter(i => !i.pinned).slice(0, 5);
      if (recent.length === 0) return null;

      return (
        <div className="mb-6">
          <h3 className="text-xs font-medium tracking-widest uppercase text-theme-muted mb-3">Recent Instances</h3>
          <div className="bg-surface-700 rounded-xl overflow-hidden divide-y divide-surface-600">
            {recent.map(instance => (
              <InstanceRow
                key={instance.id}
                instance={instance}
                onClick={() => onSelectInstance(instance.id)}
              />
            ))}
          </div>
        </div>
      );
    };

    // Home Page container
    const HomePage = ({ instances, showWelcome, onDismissWelcome, onNewInstance, onViewAll, onSelectInstance }) => (
      <div className="flex-1 overflow-auto bg-surface-800 p-6">
        <div className="max-w-4xl mx-auto">
          <GettingStartedBanner visible={showWelcome} onDismiss={onDismissWelcome} />
          <StatCards instances={instances} />
          <QuickActions onNewInstance={onNewInstance} onViewAll={onViewAll} />
          <PinnedInstances instances={instances} onSelectInstance={onSelectInstance} />
          <RecentInstances instances={instances} onSelectInstance={onSelectInstance} />
        </div>
      </div>
    );

    // ============ END HOME PAGE COMPONENTS ============

    // ============ FOCUS MODE COMPONENTS ============

    // Expand button for focus mode
    const ExpandButton = ({ onClick, expanded = false, className = '' }) => (
      <button
        onClick={(e) => { e.stopPropagation(); onClick(); }}
        className={`p-1 rounded transition-all text-gray-500 hover:text-accent hover:bg-accent/10 hover-scale press-effect ${className}`}
        title={expanded ? 'Collapse (Escape)' : 'Expand (Enter or double-click)'}
      >
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          {expanded ? (
            <path d="M4 14h6v6M20 10h-6V4M14 10l7-7M3 21l7-7" />
          ) : (
            <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" />
          )}
        </svg>
      </button>
    );

    // Thumbnail instance for focus mode sidebar
    const ThumbnailInstance = ({ instance, isActive, onClick }) => (
      <div
        onClick={onClick}
        className={`flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer transition-all hover:bg-surface-600
          ${isActive ? 'bg-surface-600 ring-1 ring-accent' : 'bg-surface-700'}`}
      >
        <StatusDot status={instance.status} size="sm" />
        <span className="text-sm font-medium truncate flex-1">{instance.name}</span>
      </div>
    );

    // Focus overlay backdrop
    const FocusOverlay = ({ onClick, children }) => (
      <div className="fixed inset-0 bg-surface-900/80 z-40 flex" onClick={onClick}>
        <div onClick={(e) => e.stopPropagation()} className="flex flex-1">
          {children}
        </div>
      </div>
    );

    // Focused terminal view for focus mode
    const FocusedTerminalView = ({ instance, onCollapse, editingInstanceId, editingName, onStartEditing, onEditingNameChange, onConfirmRename, onCancelEditing }) => (
      <div className="flex-1 bg-surface-900 flex flex-col rounded-xl overflow-hidden shadow-2xl ring-2 ring-accent active-glow expand-in terminal-glow">
        <div className="flex items-center justify-between px-4 py-3 bg-surface-800 border-b border-surface-600">
          <div className="flex items-center gap-3">
            <StatusDot status={instance.status} size="lg" />
            <EditableName
              instance={instance}
              isEditing={editingInstanceId === instance.id}
              editingName={editingName}
              onStartEdit={() => onStartEditing(instance.id, instance.name)}
              onNameChange={onEditingNameChange}
              onConfirm={() => onConfirmRename(instance.id)}
              onCancel={onCancelEditing}
              className="text-lg"
            />
            <StatusBadge status={instance.status} />
          </div>
          <div className="flex items-center gap-4">
            <span className="text-xs text-gray-500 font-mono font-light">{instance.workingDir}</span>
            <ExpandButton onClick={onCollapse} expanded={true} />
          </div>
        </div>
        <div className="flex-1 p-4 terminal-text text-gray-300 overflow-auto">
          {instance.lastOutput.map((line, i) => (
            <div key={i} className="py-0.5">{line}</div>
          ))}
          <div className="mt-4 text-gray-600">
            ─────────────────────────────────────────────<br/>
            [Terminal output would appear here]<br/>
            This is a mockup preview of the terminal<br/>
            Press Escape or click outside to exit focus mode<br/>
            ─────────────────────────────────────────────
          </div>
        </div>
      </div>
    );

    // ============ END FOCUS MODE COMPONENTS ============

    // ============ EDITABLE NAME COMPONENT ============

    // Editable name component for inline renaming
    const EditableName = ({
      instance, isEditing, editingName,
      onStartEdit, onNameChange, onConfirm, onCancel,
      className = ''
    }) => {
      const inputRef = React.useRef(null);

      useEffect(() => {
        if (isEditing && inputRef.current) {
          inputRef.current.focus();
          inputRef.current.select();
        }
      }, [isEditing]);

      const handleKeyDown = (e) => {
        if (e.key === 'Enter') { e.preventDefault(); onConfirm(); }
        if (e.key === 'Escape') { e.preventDefault(); onCancel(); }
      };

      if (isEditing) {
        return (
          <input
            ref={inputRef}
            type="text"
            value={editingName}
            onChange={(e) => onNameChange(e.target.value)}
            onKeyDown={handleKeyDown}
            onBlur={onConfirm}
            onClick={(e) => e.stopPropagation()}
            maxLength={32}
            className={`bg-surface-900 border border-accent rounded px-2 py-0.5
              text-theme-primary font-semibold outline-none
              focus:ring-2 focus:ring-accent/50 ${className}`}
            style={{ width: `${Math.max(editingName.length, 8)}ch` }}
          />
        );
      }

      return (
        <span
          className={`font-semibold cursor-text hover:text-accent-bright transition-colors ${className}`}
          onDoubleClick={(e) => { e.stopPropagation(); onStartEdit(); }}
          title="Double-click to rename"
        >
          {instance.name}
        </span>
      );
    };

    // ============ END EDITABLE NAME COMPONENT ============

    // ============ CONFIRMATION DIALOG ============

    // Confirmation dialog for closing instances
    const ConfirmDialog = ({ isOpen, onConfirm, onCancel, instance }) => {
      if (!isOpen || !instance) return null;

      const getMessage = () => {
        if (instance.status === 'working') {
          return `"${instance.name}" is currently working. Are you sure you want to close it?`;
        }
        if (instance.status === 'awaiting') {
          return `"${instance.name}" is awaiting input. Are you sure you want to close it?`;
        }
        if (instance.status === 'error') {
          return `"${instance.name}" has an error. Are you sure you want to close it?`;
        }
        if (instance.pinned) {
          return `"${instance.name}" is pinned. Are you sure you want to close it?`;
        }
        return `Close "${instance.name}"?`;
      };

      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="card-elevated rounded-xl p-6 max-w-md shadow-2xl animate-in">
            <h3 className="text-lg font-semibold mb-2">Close Instance</h3>
            <p className="text-theme-muted mb-6">{getMessage()}</p>
            <div className="flex justify-end gap-3">
              <button
                onClick={onCancel}
                className="px-4 py-2 rounded-lg text-theme-muted hover:text-theme-primary hover:bg-surface-600 transition-colors"
              >
                Cancel
              </button>
              <button
                onClick={onConfirm}
                className="px-4 py-2 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30 border border-red-500/30 transition-colors"
              >
                Close Instance
              </button>
            </div>
          </div>
        </div>
      );
    };

    // ============ END CONFIRMATION DIALOG ============

    // ============ KEYBOARD SHORTCUTS MODAL ============
    const ShortcutsModal = ({ isOpen, onClose }) => {
      if (!isOpen) return null;

      const shortcuts = [
        {
          category: 'Navigation',
          items: [
            { keys: ['⌘', '1-9'], description: 'Switch to tab by number' },
            { keys: ['⌘', '['], description: 'Previous tab' },
            { keys: ['⌘', ']'], description: 'Next tab' },
          ]
        },
        {
          category: 'Instances',
          items: [
            { keys: ['Enter'], description: 'Enter focus mode' },
            { keys: ['Esc'], description: 'Exit focus mode / Cancel' },
            { keys: ['F2'], description: 'Rename active instance' },
            { keys: ['⌘', 'W'], description: 'Close active instance' },
          ]
        },
        {
          category: 'Panels',
          items: [
            { keys: ['⌘', 'E'], description: 'Toggle plans panel' },
            { keys: ['⌘', '⇧', 'E'], description: 'Full-screen editor' },
          ]
        },
        {
          category: 'General',
          items: [
            { keys: ['⌘', '?'], description: 'Show keyboard shortcuts' },
          ]
        },
      ];

      return (
        <div
          className="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
          onClick={onClose}
        >
          <div
            className="card-elevated rounded-xl shadow-2xl animate-in max-w-lg w-full mx-4"
            onClick={(e) => e.stopPropagation()}
          >
            {/* Header */}
            <div className="flex items-center justify-between px-6 py-4 border-b border-surface-600">
              <h2 className="text-lg font-semibold">Keyboard Shortcuts</h2>
              <button
                onClick={onClose}
                className="p-1.5 rounded-lg text-theme-muted hover:text-theme-primary hover:bg-surface-600 transition-colors"
              >
                {Icons.close}
              </button>
            </div>

            {/* Content */}
            <div className="px-6 py-4 max-h-[60vh] overflow-auto">
              {shortcuts.map((section, idx) => (
                <div key={section.category} className={idx > 0 ? 'mt-6' : ''}>
                  <h3 className="text-xs font-semibold text-theme-muted uppercase tracking-wider mb-3">
                    {section.category}
                  </h3>
                  <div className="space-y-2">
                    {section.items.map((shortcut, i) => (
                      <div key={i} className="flex items-center justify-between py-1.5">
                        <span className="text-theme-primary">{shortcut.description}</span>
                        <div className="flex items-center gap-1">
                          {shortcut.keys.map((key, k) => (
                            <kbd
                              key={k}
                              className="px-2 py-1 bg-surface-700 border border-surface-500 rounded text-xs font-mono text-theme-muted min-w-[24px] text-center"
                            >
                              {key}
                            </kbd>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>

            {/* Footer */}
            <div className="px-6 py-3 border-t border-surface-600 text-center">
              <span className="text-xs text-theme-muted">
                Press <kbd className="px-1.5 py-0.5 bg-surface-700 border border-surface-500 rounded text-xs font-mono">Esc</kbd> to close
              </span>
            </div>
          </div>
        </div>
      );
    };
    // ============ END KEYBOARD SHORTCUTS MODAL ============

    // Mock data - instances with working directories
    // Plans are auto-discovered from {workingDir}/plans/ if it exists
    const mockInstances = [
      {
        id: '1',
        name: 'auth-refactor',
        status: 'working',
        pinned: true,
        workingDir: '~/projects/webapp',
        hasPlansDir: true,
        lastOutput: [
          '$ claude',
          '> Refactoring authentication middleware...',
          '> Reading src/middleware/auth.ts',
          '> Analyzing token validation logic...',
        ]
      },
      {
        id: '2',
        name: 'api-tests',
        status: 'awaiting',
        pinned: false,
        workingDir: '~/projects/webapp',
        hasPlansDir: true,
        lastOutput: [
          '$ claude',
          '> I\'ve created 12 new test cases for the API endpoints.',
          '> Would you like me to run them now?',
          '█',
        ]
      },
      {
        id: '3',
        name: 'docs-update',
        status: 'idle',
        pinned: false,
        workingDir: '~/projects/docs-site',
        hasPlansDir: true,
        lastOutput: [
          '$ claude',
          '> Documentation updated successfully.',
          '> ',
          '$ ',
        ]
      },
      {
        id: '4',
        name: 'bug-fix-cart',
        status: 'error',
        pinned: true,
        workingDir: '~/projects/webapp',
        hasPlansDir: true,
        lastOutput: [
          '$ claude',
          '> Attempting to fix cart calculation...',
          '> Error: Cannot read property \'price\' of undefined',
          '> Stack trace: ...',
        ]
      },
      {
        id: '5',
        name: 'feature-search',
        status: 'working',
        pinned: false,
        workingDir: '~/projects/webapp',
        hasPlansDir: true,
        lastOutput: [
          '$ claude',
          '> Implementing fuzzy search algorithm...',
          '> Writing src/search/fuzzy.ts',
          '> █',
        ]
      },
    ];

    // Plans are per working directory - discovered from {workingDir}/plans/
    const mockPlansByDir = {
      '~/projects/webapp': [
        {
          id: 'plan-1',
          name: 'auth-refactor-plan.md',
          folder: null,
          content: `# Authentication Refactor Plan

## Objective
Refactor the authentication middleware to use JWT tokens with refresh token rotation.

## Tasks
- Analyze current session-based auth implementation
- Design new JWT token structure
- Implement token generation and validation
- Add refresh token rotation logic
- Update all protected routes
- Write comprehensive tests

## Notes
This should be **backward compatible** with existing sessions during migration.`,
          isDirty: false,
        },
        {
          id: 'plan-2',
          name: 'api-design.md',
          folder: null,
          content: `# API Design Guidelines

## REST Conventions
- Use plural nouns for resources
- HTTP verbs for actions
- Consistent error responses`,
          isDirty: false,
        },
        {
          id: 'plan-3',
          name: 'cart-bugfix.md',
          folder: null,
          content: `# Cart Bug Fix

## Issue
Cart total shows NaN when discount is applied.

## Root Cause
The discount object is undefined when no coupon is entered.

## Solution
Add null check before accessing discount.amount`,
          isDirty: true,
        },
        {
          id: 'plan-4',
          name: 'feature-template.md',
          folder: 'templates',
          content: `# Feature: {{FEATURE_NAME}}

## Overview
Brief description of the feature.

## Requirements
- Requirement 1
- Requirement 2

## Implementation Plan
1. Step one
2. Step two`,
          isDirty: false,
        },
        {
          id: 'plan-5',
          name: 'bug-fix-template.md',
          folder: 'templates',
          content: `# Bug Fix: {{BUG_ID}}

## Problem
Description of the bug.

## Root Cause
Analysis of what caused it.

## Solution
How to fix it.`,
          isDirty: false,
        },
      ],
      '~/projects/docs-site': [
        {
          id: 'docs-plan-1',
          name: 'documentation-roadmap.md',
          folder: null,
          content: `# Documentation Roadmap

## Goals
- Improve getting started guide
- Add API reference section
- Create tutorial series

## Priority
1. Quick start guide
2. Configuration reference
3. Advanced topics`,
          isDirty: false,
        },
        {
          id: 'docs-plan-2',
          name: 'style-guide.md',
          folder: null,
          content: `# Documentation Style Guide

## Writing Style
- Use active voice
- Keep sentences short
- Include code examples

## Formatting
- Use headers for structure
- Add screenshots where helpful`,
          isDirty: true,
        },
      ],
    };

    // Mock session history data
    const mockSessions = [
      {
        id: 'session-1',
        name: 'auth-refactor',
        workingDir: '~/projects/webapp',
        timestamp: new Date(),
        messageCount: 47,
        tokenCount: 12400,
        summary: 'Refactored authentication middleware to use JWT',
        messages: [
          { type: 'user', preview: 'Help me refactor the auth middleware', tokens: 45 },
          { type: 'assistant', preview: "I'll analyze the current implementation...", tokens: 230 },
          { type: 'tool', preview: 'Read src/middleware/auth.ts', toolName: 'Read' },
          { type: 'assistant', preview: "I've identified 3 areas for improvement...", tokens: 890 },
        ]
      },
      {
        id: 'session-2',
        name: 'api-tests',
        workingDir: '~/projects/webapp/tests',
        timestamp: new Date(Date.now() - 3600000),
        messageCount: 23,
        tokenCount: 5200,
        summary: 'Created test suite for API endpoints',
        messages: [
          { type: 'user', preview: 'Create tests for the user API endpoints', tokens: 28 },
          { type: 'assistant', preview: "I'll create a comprehensive test suite...", tokens: 180 },
          { type: 'tool', preview: 'Write tests/api.test.ts', toolName: 'Write' },
        ]
      },
      {
        id: 'session-3',
        name: 'bug-investigation',
        workingDir: '~/projects/webapp/src',
        timestamp: new Date(Date.now() - 86400000),
        messageCount: 15,
        tokenCount: 3800,
        summary: 'Investigated and fixed cart calculation bug',
        messages: [
          { type: 'user', preview: 'The cart total is wrong when discounts apply', tokens: 42 },
          { type: 'tool', preview: 'Grep "discount" in src/cart/', toolName: 'Grep' },
          { type: 'assistant', preview: 'I found the issue in calculateTotal()...', tokens: 280 },
        ]
      },
    ];

    // Icons
    const Icons = {
      file: (
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
          <polyline points="14 2 14 8 20 8" />
        </svg>
      ),
      folder: (
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
        </svg>
      ),
      folderOpen: (
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2v1" />
          <path d="M5 12h14l2 7H3l2-7z" />
        </svg>
      ),
      chevronRight: (
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polyline points="9 18 15 12 9 6" />
        </svg>
      ),
      chevronDown: (
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polyline points="6 9 12 15 18 9" />
        </svg>
      ),
      plus: (
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M12 5v14M5 12h14" />
        </svg>
      ),
      expand: (
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" />
        </svg>
      ),
      collapse: (
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M4 14h6v6M20 10h-6V4M14 10l7-7M3 21l7-7" />
        </svg>
      ),
      panelRight: (
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <rect x="3" y="3" width="18" height="18" rx="2" />
          <path d="M15 3v18" />
        </svg>
      ),
      panelRightClose: (
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <rect x="3" y="3" width="18" height="18" rx="2" />
          <path d="M15 3v18" />
          <path d="M10 15l3-3-3-3" />
        </svg>
      ),
      close: (
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M18 6L6 18M6 6l12 12" />
        </svg>
      ),
      inject: (
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M12 5v14M5 12l7 7 7-7" />
        </svg>
      ),
      sun: (
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <circle cx="12" cy="12" r="5" />
          <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
        </svg>
      ),
      moon: (
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
        </svg>
      ),
      history: (
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      ),
      star: (pinned) => (
        <svg width="14" height="14" viewBox="0 0 24 24" fill={pinned ? 'currentColor' : 'none'} stroke="currentColor" strokeWidth="2">
          <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26" />
        </svg>
      ),
      noPlans: (
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" className="mx-auto opacity-50">
          <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
          <line x1="12" y1="11" x2="12" y2="17" />
          <line x1="9" y1="14" x2="15" y2="14" />
        </svg>
      ),
    };

    // Tooltip
    const Tooltip = ({ children, text, position = 'top' }) => (
      <div className="relative group/tooltip inline-flex">
        {children}
        <div className={`
          absolute z-50 px-2 py-1 text-xs font-medium
          bg-surface-600 text-white rounded shadow-lg
          opacity-0 group-hover/tooltip:opacity-100
          transition-opacity duration-200 delay-300
          pointer-events-none whitespace-nowrap
          ${position === 'top' ? 'bottom-full left-1/2 -translate-x-1/2 mb-2' : ''}
          ${position === 'bottom' ? 'top-full left-1/2 -translate-x-1/2 mt-2' : ''}
          ${position === 'left' ? 'right-full top-1/2 -translate-y-1/2 mr-2' : ''}
        `}>
          {text}
        </div>
      </div>
    );

    // Layout switcher
    const LayoutSwitcher = ({ layout, onChange }) => {
      const layouts = [
        { id: 'tabs', icon: '⊞', label: 'Tabs' },
        { id: 'cards', icon: '⊟', label: 'Cards' },
        { id: 'list', icon: '☰', label: 'List' },
      ];

      return (
        <div className="flex items-center gap-1 bg-surface-700 rounded-lg p-1">
          {layouts.map(l => (
            <button
              key={l.id}
              onClick={() => onChange(l.id)}
              className={`
                px-3 py-1.5 rounded-md text-sm font-medium transition-colors
                ${layout === l.id
                  ? 'bg-surface-500 text-theme-primary'
                  : 'text-theme-muted hover:text-theme-primary'}
              `}
              title={l.label}
            >
              {l.icon}
            </button>
          ))}
        </div>
      );
    };

    // Theme toggle
    const ThemeToggle = ({ isDark, onToggle }) => (
      <Tooltip text={isDark ? 'Light mode' : 'Dark mode'} position="bottom">
        <button
          onClick={onToggle}
          className="p-2 rounded-lg text-theme-muted hover:text-theme-primary hover:bg-surface-600 transition-colors"
        >
          {isDark ? Icons.sun : Icons.moon}
        </button>
      </Tooltip>
    );

    // Pin icon
    const PinIcon = ({ pinned, onClick, size = 'md' }) => (
      <button
        onClick={(e) => { e.stopPropagation(); onClick(); }}
        className={`p-1 rounded transition-all transform hover:scale-110 active:scale-95
          ${pinned ? 'text-accent hover:text-accent-bright' : 'text-gray-500 hover:text-gray-300'}`}
        title={pinned ? 'Unpin' : 'Pin'}
      >
        {Icons.star(pinned)}
      </button>
    );

    // Close button
    const CloseButton = ({ onClick, className = '' }) => (
      <button
        onClick={(e) => { e.stopPropagation(); onClick(); }}
        className={`p-1 rounded transition-all text-gray-500 hover:text-red-400 hover:bg-red-400/10 hover-scale press-effect ${className}`}
      >
        {Icons.close}
      </button>
    );

    // Fake MDX Editor Toolbar
    const EditorToolbar = ({ onInject }) => (
      <div className="flex items-center gap-1 px-3 py-2 bg-surface-700 border-b border-surface-600">
        <div className="flex items-center gap-0.5">
          <button className="p-1.5 rounded hover:bg-surface-600 text-theme-muted hover:text-theme-primary transition-colors font-bold text-sm">B</button>
          <button className="p-1.5 rounded hover:bg-surface-600 text-theme-muted hover:text-theme-primary transition-colors italic text-sm">I</button>
          <button className="p-1.5 rounded hover:bg-surface-600 text-theme-muted hover:text-theme-primary transition-colors underline text-sm">U</button>
        </div>
        <div className="w-px h-5 bg-surface-600 mx-1" />
        <div className="flex items-center gap-0.5">
          <button className="px-2 py-1 rounded hover:bg-surface-600 text-theme-muted hover:text-theme-primary transition-colors text-xs font-medium">H1</button>
          <button className="px-2 py-1 rounded hover:bg-surface-600 text-theme-muted hover:text-theme-primary transition-colors text-xs font-medium">H2</button>
        </div>
        <div className="w-px h-5 bg-surface-600 mx-1" />
        <div className="flex items-center gap-0.5">
          <button className="p-1.5 rounded hover:bg-surface-600 text-theme-muted hover:text-theme-primary transition-colors text-sm">•</button>
          <button className="p-1.5 rounded hover:bg-surface-600 text-theme-muted hover:text-theme-primary transition-colors text-sm">1.</button>
        </div>
        <div className="flex-1" />
        <Tooltip text="Inject plan into terminal" position="left">
          <button
            onClick={onInject}
            className="flex items-center gap-1.5 px-2 py-1 rounded bg-accent/20 text-accent hover:bg-accent/30 transition-colors text-xs font-medium"
          >
            {Icons.inject}
            Inject
          </button>
        </Tooltip>
      </div>
    );

    // Plans Browser (resizable, not collapsible)
    const PlansBrowser = ({ plans, selectedPlanId, onSelectPlan, onNewPlan, height, onResizeStart }) => {
      const [expandedFolders, setExpandedFolders] = useState(new Set(['templates']));

      const toggleFolder = (folder) => {
        setExpandedFolders(prev => {
          const next = new Set(prev);
          if (next.has(folder)) next.delete(folder);
          else next.add(folder);
          return next;
        });
      };

      const rootPlans = plans.filter(p => !p.folder);
      const folders = [...new Set(plans.filter(p => p.folder).map(p => p.folder))];

      return (
        <div className="flex flex-col bg-surface-800" style={{ height }}>
          {/* Header */}
          <div className="flex items-center justify-between px-3 py-2 border-b border-surface-600">
            <span className="text-xs font-medium text-theme-muted uppercase tracking-wider">Plans</span>
            <Tooltip text="New plan" position="bottom">
              <button onClick={onNewPlan} className="p-1 rounded hover:bg-surface-700 text-theme-muted hover:text-accent transition-colors">
                {Icons.plus}
              </button>
            </Tooltip>
          </div>

          {/* File tree */}
          <div className="flex-1 overflow-auto py-1">
            {rootPlans.map(plan => (
              <div
                key={plan.id}
                onClick={() => onSelectPlan(plan.id)}
                className={`flex items-center gap-2 px-3 py-1.5 cursor-pointer text-sm transition-colors hover:bg-surface-700
                  ${selectedPlanId === plan.id ? 'bg-surface-700 text-accent' : 'text-theme-secondary'}`}
              >
                <span className="text-theme-muted">{Icons.file}</span>
                <span className="truncate flex-1">{plan.name}</span>
                {plan.isDirty && <span className="w-2 h-2 rounded-full bg-accent" />}
              </div>
            ))}

            {folders.map(folder => (
              <div key={folder}>
                <div
                  onClick={() => toggleFolder(folder)}
                  className="flex items-center gap-2 px-3 py-1.5 cursor-pointer text-sm text-theme-secondary hover:bg-surface-700 transition-colors"
                >
                  <span className="text-theme-muted">
                    {expandedFolders.has(folder) ? Icons.chevronDown : Icons.chevronRight}
                  </span>
                  <span className="text-theme-muted">
                    {expandedFolders.has(folder) ? Icons.folderOpen : Icons.folder}
                  </span>
                  <span>{folder}</span>
                </div>
                {expandedFolders.has(folder) && plans
                  .filter(p => p.folder === folder)
                  .map(plan => (
                    <div
                      key={plan.id}
                      onClick={() => onSelectPlan(plan.id)}
                      className={`flex items-center gap-2 pl-8 pr-3 py-1.5 cursor-pointer text-sm transition-colors hover:bg-surface-700
                        ${selectedPlanId === plan.id ? 'bg-surface-700 text-accent' : 'text-theme-secondary'}`}
                    >
                      <span className="text-theme-muted">{Icons.file}</span>
                      <span className="truncate flex-1">{plan.name}</span>
                      {plan.isDirty && <span className="w-2 h-2 rounded-full bg-accent" />}
                    </div>
                  ))}
              </div>
            ))}
          </div>

          {/* Resize handle */}
          <div className="resize-handle-v" onMouseDown={onResizeStart} />
        </div>
      );
    };

    // Editor Content
    const EditorContent = ({ content, onChange }) => {
      const renderContent = (text) => {
        const lines = text.split('\n');
        const elements = [];
        let inList = false;
        let listItems = [];

        const flushList = () => {
          if (listItems.length > 0) {
            elements.push(<ul key={`list-${elements.length}`}>{listItems}</ul>);
            listItems = [];
            inList = false;
          }
        };

        lines.forEach((line, i) => {
          if (line.startsWith('# ')) {
            flushList();
            elements.push(<h1 key={i}>{line.slice(2)}</h1>);
          } else if (line.startsWith('## ')) {
            flushList();
            elements.push(<h2 key={i}>{line.slice(3)}</h2>);
          } else if (line.startsWith('- ')) {
            inList = true;
            const text = line.slice(2).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            listItems.push(<li key={i} dangerouslySetInnerHTML={{ __html: text }} />);
          } else if (line.trim() === '') {
            flushList();
          } else {
            flushList();
            const text = line
              .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
              .replace(/`(.*?)`/g, '<code>$1</code>');
            elements.push(<p key={i} dangerouslySetInnerHTML={{ __html: text }} />);
          }
        });
        flushList();
        return elements;
      };

      return (
        <div
          className="flex-1 overflow-auto p-4 editor-content text-theme-primary focus:outline-none"
          contentEditable
          suppressContentEditableWarning
        >
          {renderContent(content)}
        </div>
      );
    };

    // Full-screen Editor Overlay
    const FullScreenEditor = ({ plan, onClose, onInject }) => (
      <div className="fixed inset-0 z-50 bg-surface-900 flex flex-col expand-in">
        <div className="flex items-center justify-between px-4 py-3 bg-surface-800 border-b border-surface-600">
          <div className="flex items-center gap-3">
            <span className="text-theme-muted">{Icons.file}</span>
            <span className="font-medium text-theme-primary">{plan.name}</span>
            {plan.isDirty && <span className="text-xs text-accent">● Unsaved</span>}
          </div>
          <div className="flex items-center gap-2">
            <button
              onClick={onInject}
              className="flex items-center gap-1.5 px-3 py-1.5 rounded bg-accent/20 text-accent hover:bg-accent/30 transition-colors text-sm font-medium"
            >
              {Icons.inject}
              Inject into Terminal
            </button>
            <button onClick={onClose} className="p-2 rounded hover:bg-surface-700 text-theme-muted hover:text-theme-primary transition-colors">
              {Icons.collapse}
            </button>
          </div>
        </div>
        <EditorToolbar onInject={onInject} />
        <EditorContent content={plan.content} onChange={() => {}} />
      </div>
    );

    // No Plans Directory State
    const NoPlansState = ({ workingDir }) => (
      <div className="flex-1 flex flex-col items-center justify-center p-6 text-center bg-surface-800">
        {Icons.noPlans}
        <p className="text-sm text-theme-muted mt-4 mb-2">No plans directory found</p>
        <p className="text-xs text-theme-dim">
          Create a <code className="bg-surface-700 px-1 rounded">plans/</code> folder in:
        </p>
        <p className="text-xs text-theme-muted font-mono mt-1">{workingDir}</p>
      </div>
    );

    // Editor Panel
    const EditorPanel = ({
      plans,
      selectedPlanId,
      instance,
      onSelectPlan,
      onNewPlan,
      onExpandEditor,
      onInject,
      browserHeight,
      onBrowserResizeStart,
    }) => {
      const selectedPlan = plans?.find(p => p.id === selectedPlanId);

      // No plans directory for this instance's working directory
      if (!instance.hasPlansDir) {
        return <NoPlansState workingDir={instance.workingDir} />;
      }

      return (
        <div className="flex flex-col h-full bg-surface-800">
          {/* Plans browser */}
          <PlansBrowser
            plans={plans || []}
            selectedPlanId={selectedPlanId}
            onSelectPlan={onSelectPlan}
            onNewPlan={onNewPlan}
            height={browserHeight}
            onResizeStart={onBrowserResizeStart}
          />

          {selectedPlan ? (
            <>
              {/* Editor header */}
              <div className="flex items-center justify-between px-3 py-2 bg-surface-700 border-b border-surface-600">
                <div className="flex items-center gap-2 min-w-0">
                  <span className="text-theme-muted">{Icons.file}</span>
                  <span className="text-sm font-medium truncate">{selectedPlan.name}</span>
                  {selectedPlan.isDirty && <span className="w-2 h-2 rounded-full bg-accent flex-shrink-0" />}
                </div>
                <Tooltip text="Full screen" position="left">
                  <button onClick={onExpandEditor} className="p-1.5 rounded hover:bg-surface-600 text-theme-muted hover:text-theme-primary transition-colors">
                    {Icons.expand}
                  </button>
                </Tooltip>
              </div>

              <EditorToolbar onInject={onInject} />
              <EditorContent content={selectedPlan.content} onChange={() => {}} />
            </>
          ) : (
            <div className="flex-1 flex items-center justify-center text-theme-muted text-sm">
              Select a plan to edit
            </div>
          )}
        </div>
      );
    };

    // Context Menu component
    const ContextMenu = ({ x, y, instance, onClose, onAction }) => {
      const menuRef = useRef(null);

      useEffect(() => {
        const handleClickOutside = (e) => {
          if (menuRef.current && !menuRef.current.contains(e.target)) {
            onClose();
          }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, [onClose]);

      const actions = [
        { id: 'rename', label: 'Rename', shortcut: 'F2' },
        { id: 'duplicate', label: 'Duplicate' },
        { id: 'divider1' },
        { id: 'pin', label: instance.pinned ? 'Unpin' : 'Pin' },
        { id: 'expand', label: 'Focus Mode', shortcut: 'Enter' },
        { id: 'divider2' },
        { id: 'closeOthers', label: 'Close Others' },
        { id: 'closeRight', label: 'Close to the Right' },
        { id: 'divider3' },
        { id: 'close', label: 'Close', shortcut: '⌘W', danger: true },
      ];

      return (
        <div
          ref={menuRef}
          className="fixed z-50 bg-surface-700 border border-surface-600 rounded-lg shadow-xl py-1 min-w-[180px] animate-in"
          style={{ left: x, top: y }}
        >
          {actions.map((action) => {
            if (action.id.startsWith('divider')) {
              return <div key={action.id} className="h-px bg-surface-600 my-1" />;
            }
            return (
              <button
                key={action.id}
                onClick={() => { onAction(action.id); onClose(); }}
                className={`w-full flex items-center justify-between px-3 py-1.5 text-sm transition-colors
                  ${action.danger
                    ? 'text-red-400 hover:bg-red-500/20'
                    : 'text-theme-primary hover:bg-surface-600'}`}
              >
                <span>{action.label}</span>
                {action.shortcut && (
                  <span className="text-xs text-theme-muted ml-4">{action.shortcut}</span>
                )}
              </button>
            );
          })}
        </div>
      );
    };

    // Tab overflow menu (shows hidden tabs when there are too many)
    const TabOverflowMenu = ({ hiddenInstances, activeId, onSelect, onClose }) => {
      const [isOpen, setIsOpen] = useState(false);
      const menuRef = useRef(null);

      useEffect(() => {
        const handleClickOutside = (e) => {
          if (menuRef.current && !menuRef.current.contains(e.target)) {
            setIsOpen(false);
          }
        };
        if (isOpen) {
          document.addEventListener('mousedown', handleClickOutside);
        }
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, [isOpen]);

      if (hiddenInstances.length === 0) return null;

      return (
        <div className="relative" ref={menuRef}>
          <button
            onClick={() => setIsOpen(!isOpen)}
            className={`flex items-center gap-1 px-2 py-1.5 rounded-lg text-sm font-medium transition-colors
              ${isOpen ? 'bg-surface-600 text-theme-primary' : 'text-theme-muted hover:text-theme-primary hover:bg-surface-700'}`}
          >
            <span className="text-xs bg-accent/20 text-accent px-1.5 py-0.5 rounded-full font-semibold">
              +{hiddenInstances.length}
            </span>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"
              className={`transition-transform ${isOpen ? 'rotate-180' : ''}`}>
              <path d="M6 9l6 6 6-6" />
            </svg>
          </button>

          {isOpen && (
            <div className="absolute right-0 top-full mt-1 z-50 bg-surface-700 border border-surface-600 rounded-lg shadow-xl py-1 min-w-[200px] max-h-[300px] overflow-auto animate-in">
              <div className="px-3 py-1.5 text-xs text-theme-muted font-medium border-b border-surface-600 mb-1">
                {hiddenInstances.length} more instance{hiddenInstances.length > 1 ? 's' : ''}
              </div>
              {hiddenInstances.map(instance => (
                <div
                  key={instance.id}
                  className={`group flex items-center gap-2 px-3 py-2 cursor-pointer transition-colors
                    ${activeId === instance.id ? 'bg-surface-600' : 'hover:bg-surface-600'}`}
                  onClick={() => { onSelect(instance.id); setIsOpen(false); }}
                >
                  <StatusDot status={instance.status} size="sm" />
                  <span className="flex-1 truncate text-sm">{instance.name}</span>
                  {instance.pinned && <span className="text-accent text-xs">★</span>}
                  <button
                    onClick={(e) => { e.stopPropagation(); onClose(instance); }}
                    className="p-0.5 rounded opacity-0 group-hover:opacity-100 text-theme-muted hover:text-red-400 transition-all"
                  >
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M18 6L6 18M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    };

    // Tab bar layout with drag-and-drop support and overflow menu
    const TabBar = ({ instances, activeId, onSelect, onTogglePin, onClose, onDoubleClick, onExpand, onReorder, onDuplicate, onCloseOthers, onCloseRight, editingInstanceId, editingName, onStartEditing, onEditingNameChange, onConfirmRename, onCancelEditing }) => {
      const [draggedId, setDraggedId] = useState(null);
      const [dragOverId, setDragOverId] = useState(null);
      const [isDragging, setIsDragging] = useState(false);
      const [contextMenu, setContextMenu] = useState(null);
      const containerRef = useRef(null);
      const [visibleCount, setVisibleCount] = useState(instances.length);

      // Calculate how many tabs can fit (simplified for mockup)
      useEffect(() => {
        const calculateVisibleTabs = () => {
          if (!containerRef.current) return;
          const containerWidth = containerRef.current.offsetWidth - 150; // Reserve space for overflow menu and + button
          const avgTabWidth = 180; // Approximate width of each tab
          const maxVisible = Math.max(2, Math.floor(containerWidth / avgTabWidth));
          setVisibleCount(Math.min(maxVisible, instances.length));
        };

        calculateVisibleTabs();
        window.addEventListener('resize', calculateVisibleTabs);
        return () => window.removeEventListener('resize', calculateVisibleTabs);
      }, [instances.length]);

      const visibleInstances = instances.slice(0, visibleCount);
      const hiddenInstances = instances.slice(visibleCount);

      const handleDragStart = (e, instanceId) => {
        setDraggedId(instanceId);
        setIsDragging(true);
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', instanceId);
      };

      const handleDragOver = (e, instanceId) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        if (draggedId && draggedId !== instanceId) {
          setDragOverId(instanceId);
        }
      };

      const handleDrop = (e, targetId) => {
        e.preventDefault();
        if (draggedId && targetId && draggedId !== targetId) {
          onReorder(draggedId, targetId);
        }
      };

      const handleDragEnd = () => {
        setDraggedId(null);
        setDragOverId(null);
        setIsDragging(false);
      };

      const handleClick = (e, instanceId) => {
        if (!isDragging) {
          onSelect(instanceId);
        }
      };

      const handleContextMenu = (e, instance) => {
        e.preventDefault();
        setContextMenu({ x: e.clientX, y: e.clientY, instance });
      };

      const handleContextAction = (actionId) => {
        const instance = contextMenu?.instance;
        if (!instance) return;

        switch (actionId) {
          case 'rename':
            onStartEditing(instance.id, instance.name);
            break;
          case 'duplicate':
            onDuplicate(instance.id);
            break;
          case 'pin':
            onTogglePin(instance.id);
            break;
          case 'expand':
            onExpand(instance.id);
            break;
          case 'closeOthers':
            onCloseOthers(instance.id);
            break;
          case 'closeRight':
            onCloseRight(instance.id);
            break;
          case 'close':
            onClose(instance);
            break;
        }
      };

      return (
        <>
          <div ref={containerRef} className="flex items-center gap-1 px-2 py-2 bg-surface-800 border-b border-surface-600">
            {visibleInstances.map((instance, i) => (
              <div
                key={instance.id}
                draggable={editingInstanceId !== instance.id}
                onDragStart={(e) => handleDragStart(e, instance.id)}
                onDragOver={(e) => handleDragOver(e, instance.id)}
                onDrop={(e) => handleDrop(e, instance.id)}
                onDragEnd={handleDragEnd}
                onDragLeave={() => setDragOverId(null)}
                onClick={(e) => handleClick(e, instance.id)}
                onDoubleClick={() => onDoubleClick(instance.id)}
                onContextMenu={(e) => handleContextMenu(e, instance)}
                className={`group flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium
                  transition-all whitespace-nowrap cursor-grab active:cursor-grabbing animate-in delay-${i + 1}
                  ${draggedId === instance.id ? 'opacity-50 scale-95' : ''}
                  ${dragOverId === instance.id ? 'ring-2 ring-accent ring-offset-1 ring-offset-surface-800 scale-105' : ''}
                  ${activeId === instance.id && dragOverId !== instance.id
                    ? 'bg-surface-600 text-theme-primary active-glow'
                    : 'text-theme-muted hover:text-theme-primary hover:bg-surface-700'}`}
              >
                {/* Drag handle indicator */}
                <span className="text-theme-dim opacity-50 group-hover:opacity-100 -ml-1 mr-0.5 select-none" title="Drag to reorder">⋮⋮</span>
                <StatusDot status={instance.status} />
                <EditableName
                  instance={instance}
                  isEditing={editingInstanceId === instance.id}
                  editingName={editingName}
                  onStartEdit={() => onStartEditing(instance.id, instance.name)}
                  onNameChange={onEditingNameChange}
                  onConfirm={() => onConfirmRename(instance.id)}
                  onCancel={onCancelEditing}
                />
                {instance.hasPlansDir && (
                  <span className="text-accent/60" title="Has plans directory">{Icons.file}</span>
                )}
                <PinIcon pinned={instance.pinned} onClick={() => onTogglePin(instance.id)} size="sm" />
                <ExpandButton onClick={() => onExpand(instance.id)} className="opacity-0 group-hover:opacity-100" />
                <CloseButton onClick={() => onClose(instance)} className="opacity-0 group-hover:opacity-100 -mr-1" />
              </div>
            ))}

            {/* Overflow menu for hidden tabs */}
            <TabOverflowMenu
              hiddenInstances={hiddenInstances}
              activeId={activeId}
              onSelect={onSelect}
              onClose={onClose}
            />

            <button className="ml-auto p-2 text-theme-muted hover:text-theme-primary hover:bg-surface-700 rounded-lg transition-colors">
              {Icons.plus}
            </button>
          </div>

          {/* Context Menu */}
          {contextMenu && (
            <ContextMenu
              x={contextMenu.x}
              y={contextMenu.y}
              instance={contextMenu.instance}
              onClose={() => setContextMenu(null)}
              onAction={handleContextAction}
            />
          )}
        </>
      );
    };

    // Card layout with drag-and-drop
    const CardLayout = ({ instances, activeId, onSelect, onTogglePin, onClose, onDoubleClick, onExpand, onReorder, editingInstanceId, editingName, onStartEditing, onEditingNameChange, onConfirmRename, onCancelEditing }) => {
      const [draggedId, setDraggedId] = useState(null);
      const [dragOverId, setDragOverId] = useState(null);
      const [isDragging, setIsDragging] = useState(false);

      const handleDragStart = (e, instanceId) => {
        setDraggedId(instanceId);
        setIsDragging(true);
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', instanceId);
      };

      const handleDragOver = (e, instanceId) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        if (draggedId && draggedId !== instanceId) {
          setDragOverId(instanceId);
        }
      };

      const handleDrop = (e, targetId) => {
        e.preventDefault();
        if (draggedId && targetId && draggedId !== targetId) {
          onReorder(draggedId, targetId);
        }
      };

      const handleDragEnd = () => {
        setDraggedId(null);
        setDragOverId(null);
        setIsDragging(false);
      };

      const handleClick = (e, instanceId) => {
        if (!isDragging) {
          onSelect(instanceId);
        }
      };

      return (
        <div className="grid grid-cols-2 lg:grid-cols-3 gap-4 p-4">
          {instances.map((instance, i) => (
            <div
              key={instance.id}
              draggable={editingInstanceId !== instance.id}
              onDragStart={(e) => handleDragStart(e, instance.id)}
              onDragOver={(e) => handleDragOver(e, instance.id)}
              onDrop={(e) => handleDrop(e, instance.id)}
              onDragEnd={handleDragEnd}
              onDragLeave={() => setDragOverId(null)}
              onClick={(e) => handleClick(e, instance.id)}
              onDoubleClick={() => onDoubleClick(instance.id)}
              className={`group relative animate-in delay-${i + 1} hover-lift
                bg-surface-700 rounded-xl p-4 cursor-grab active:cursor-grabbing transition-all hover:bg-surface-600
                ${draggedId === instance.id ? 'opacity-50 scale-95' : ''}
                ${dragOverId === instance.id ? 'ring-2 ring-accent ring-offset-2 ring-offset-surface-800 scale-[1.02]' : ''}
                ${activeId === instance.id && dragOverId !== instance.id ? 'ring-2 ring-accent active-glow' : ''}`}
            >
              {/* Drag handle indicator */}
              <div className="absolute top-2 left-2 text-theme-dim opacity-50 group-hover:opacity-100 text-xs select-none" title="Drag to reorder">⋮⋮</div>
              <div className="absolute top-3 right-3 flex items-center gap-1 opacity-0 group-hover:opacity-100">
                <ExpandButton onClick={() => onExpand(instance.id)} />
                <CloseButton onClick={() => onClose(instance)} />
              </div>
              <div className="flex items-center justify-between mb-3 pr-12">
                <div className="flex items-center gap-2">
                  <StatusDot status={instance.status} size="lg" />
                  <EditableName
                    instance={instance}
                    isEditing={editingInstanceId === instance.id}
                    editingName={editingName}
                    onStartEdit={() => onStartEditing(instance.id, instance.name)}
                    onNameChange={onEditingNameChange}
                    onConfirm={() => onConfirmRename(instance.id)}
                    onCancel={onCancelEditing}
                  />
                  {instance.hasPlansDir && <span className="text-accent/60">{Icons.file}</span>}
                </div>
                <PinIcon pinned={instance.pinned} onClick={() => onTogglePin(instance.id)} />
              </div>
              <StatusBadge status={instance.status} />
              <div className="mt-3 text-xs text-gray-500 font-mono truncate">{instance.workingDir}</div>
              <div className="mt-3 bg-surface-900 rounded-lg p-3 h-20 overflow-hidden">
                <div className="terminal-text text-gray-400">
                  {instance.lastOutput.slice(-2).map((line, i) => (
                    <div key={i} className="truncate">{line}</div>
                  ))}
                </div>
              </div>
            </div>
          ))}
          <div className="bg-surface-800 rounded-xl p-4 border-2 border-dashed border-surface-600 flex items-center justify-center cursor-pointer hover:border-surface-500 transition-colors min-h-[200px]">
            <div className="text-center text-gray-500">
              <div className="w-8 h-8 mx-auto mb-2">{Icons.plus}</div>
              <span className="text-sm">New Instance</span>
            </div>
          </div>
        </div>
      );
    };

    // List layout with drag-and-drop
    const ListLayout = ({ instances, activeId, onSelect, onTogglePin, onClose, onDoubleClick, onExpand, onReorder, editingInstanceId, editingName, onStartEditing, onEditingNameChange, onConfirmRename, onCancelEditing }) => {
      const [draggedId, setDraggedId] = useState(null);
      const [dragOverId, setDragOverId] = useState(null);
      const [isDragging, setIsDragging] = useState(false);

      const handleDragStart = (e, instanceId) => {
        setDraggedId(instanceId);
        setIsDragging(true);
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', instanceId);
      };

      const handleDragOver = (e, instanceId) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        if (draggedId && draggedId !== instanceId) {
          setDragOverId(instanceId);
        }
      };

      const handleDrop = (e, targetId) => {
        e.preventDefault();
        if (draggedId && targetId && draggedId !== targetId) {
          onReorder(draggedId, targetId);
        }
      };

      const handleDragEnd = () => {
        setDraggedId(null);
        setDragOverId(null);
        setIsDragging(false);
      };

      const handleClick = (e, instanceId) => {
        // Don't select if we just finished dragging
        if (!isDragging) {
          onSelect(instanceId);
        }
      };

      return (
        <div className="divide-y divide-surface-600">
          {instances.map((instance, i) => (
            <div
              key={instance.id}
              draggable={editingInstanceId !== instance.id}
              onDragStart={(e) => handleDragStart(e, instance.id)}
              onDragOver={(e) => handleDragOver(e, instance.id)}
              onDrop={(e) => handleDrop(e, instance.id)}
              onDragEnd={handleDragEnd}
              onDragLeave={() => setDragOverId(null)}
              onClick={(e) => handleClick(e, instance.id)}
              onDoubleClick={() => onDoubleClick(instance.id)}
              className={`group animate-in delay-${i + 1} flex items-center gap-4 px-4 py-3 cursor-grab active:cursor-grabbing
                transition-all hover:bg-surface-700 relative
                ${draggedId === instance.id ? 'opacity-50 scale-[0.98]' : ''}
                ${dragOverId === instance.id ? 'bg-accent/20 ring-2 ring-accent ring-inset' : ''}
                ${activeId === instance.id && dragOverId !== instance.id ? 'bg-surface-700' : ''}`}
            >
              {/* Drop indicator line */}
              {dragOverId === instance.id && (
                <div className="absolute -top-px left-0 right-0 h-0.5 bg-accent" />
              )}
              {/* Drag handle */}
              <span className="text-theme-dim opacity-50 group-hover:opacity-100 cursor-grab select-none" title="Drag to reorder">⋮⋮</span>
              <PinIcon pinned={instance.pinned} onClick={() => onTogglePin(instance.id)} />
              <StatusDot status={instance.status} size="lg" />
              <div className="flex-1 min-w-0">
                <div className="flex items-center gap-2">
                  <EditableName
                    instance={instance}
                    isEditing={editingInstanceId === instance.id}
                    editingName={editingName}
                    onStartEdit={() => onStartEditing(instance.id, instance.name)}
                    onNameChange={onEditingNameChange}
                    onConfirm={() => onConfirmRename(instance.id)}
                    onCancel={onCancelEditing}
                  />
                  {instance.hasPlansDir && <span className="text-accent/60">{Icons.file}</span>}
                </div>
                <div className="text-xs text-gray-500 font-mono truncate">{instance.workingDir}</div>
              </div>
              <StatusBadge status={instance.status} />
              <div className="text-xs text-gray-500 w-48 truncate terminal-text">
                {instance.lastOutput[instance.lastOutput.length - 1]}
              </div>
              <ExpandButton onClick={() => onExpand(instance.id)} className="opacity-0 group-hover:opacity-100" />
              <CloseButton onClick={() => onClose(instance)} className="opacity-0 group-hover:opacity-100" />
            </div>
          ))}
        </div>
      );
    };

    // Terminal view
    const TerminalView = ({ instance, editingInstanceId, editingName, onStartEditing, onEditingNameChange, onConfirmRename, onCancelEditing }) => (
      <div className="flex-1 bg-surface-900 flex flex-col terminal-glow">
        <div className="flex items-center justify-between px-4 py-2 bg-surface-800 border-b border-surface-600">
          <div className="flex items-center gap-3">
            <StatusDot status={instance.status} size="lg" />
            <EditableName
              instance={instance}
              isEditing={editingInstanceId === instance.id}
              editingName={editingName}
              onStartEdit={() => onStartEditing(instance.id, instance.name)}
              onNameChange={onEditingNameChange}
              onConfirm={() => onConfirmRename(instance.id)}
              onCancel={onCancelEditing}
            />
            <StatusBadge status={instance.status} />
          </div>
          <div className="text-xs text-theme-muted font-mono">{instance.workingDir}</div>
        </div>
        <div className="flex-1 p-4 terminal-text text-gray-300 overflow-auto">
          {instance.lastOutput.map((line, i) => (
            <div key={i} className="py-0.5">{line}</div>
          ))}
          <div className="mt-4 text-gray-600">
            ─────────────────────────────────────────────<br/>
            [Terminal output would appear here]<br/>
            This is a mockup preview of the terminal<br/>
            ─────────────────────────────────────────────
          </div>
        </div>
      </div>
    );

    // Session card for history view
    const SessionCard = ({ session, isExpanded, onToggle }) => {
      const formatTime = (date) => date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
      const formatTokens = (count) => count >= 1000 ? `${(count / 1000).toFixed(1)}k` : count;

      const typeStyles = {
        user: { icon: '👤', color: 'text-accent' },
        assistant: { icon: '🤖', color: 'text-state-working' },
        tool: { icon: '🔧', color: 'text-theme-muted' },
      };

      return (
        <div className="bg-surface-700 rounded-xl overflow-hidden hover-lift">
          <div
            className="flex items-center justify-between p-4 cursor-pointer hover:bg-surface-600/50 transition-colors"
            onClick={onToggle}
          >
            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-2 mb-1">
                <span className="font-semibold text-theme-primary">{session.name}</span>
                <span className="text-xs text-theme-muted">{formatTime(session.timestamp)}</span>
              </div>
              <div className="text-xs text-theme-muted font-mono">{session.workingDir}</div>
              <div className="flex items-center gap-3 mt-1 text-xs text-theme-muted">
                <span>{session.messageCount} messages</span>
                <span className="text-theme-dim">•</span>
                <span>{formatTokens(session.tokenCount)} tokens</span>
                <span className="text-theme-dim">•</span>
                <span className="truncate italic">"{session.summary}"</span>
              </div>
            </div>
            <svg
              width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"
              className={`text-theme-muted transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}`}
            >
              <path d="M6 9l6 6 6-6" />
            </svg>
          </div>

          {isExpanded && (
            <div className="border-t border-surface-600 p-4 bg-surface-800/50 space-y-2">
              {session.messages.map((msg, i) => {
                const style = typeStyles[msg.type] || typeStyles.assistant;
                return (
                  <div key={i} className="flex gap-3 py-1">
                    <span className={`text-sm ${style.color}`}>{style.icon}</span>
                    <div className="flex-1 min-w-0">
                      <span className={`text-xs ${style.color} font-medium`}>{msg.toolName || msg.type}</span>
                      <p className="text-sm text-theme-secondary truncate">{msg.preview}</p>
                    </div>
                    {msg.tokens && <span className="text-xs text-theme-dim">{msg.tokens} tok</span>}
                  </div>
                );
              })}
            </div>
          )}
        </div>
      );
    };

    // History view
    const HistoryView = ({ sessions, expandedSessions, onToggleSession, onClose }) => {
      const [searchQuery, setSearchQuery] = useState('');

      const groupByDate = (sessions) => {
        const today = new Date(); today.setHours(0, 0, 0, 0);
        const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);

        const groups = { today: [], yesterday: [], older: [] };
        sessions.forEach(session => {
          const sessionDate = new Date(session.timestamp); sessionDate.setHours(0, 0, 0, 0);
          if (sessionDate.getTime() === today.getTime()) groups.today.push(session);
          else if (sessionDate.getTime() === yesterday.getTime()) groups.yesterday.push(session);
          else groups.older.push(session);
        });
        return groups;
      };

      const filteredSessions = searchQuery
        ? sessions.filter(s =>
            s.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
            s.summary.toLowerCase().includes(searchQuery.toLowerCase())
          )
        : sessions;

      const grouped = groupByDate(filteredSessions);

      const DateGroup = ({ label, children }) => (
        <div className="mb-6">
          <h3 className="text-xs font-medium tracking-widest uppercase text-theme-muted mb-3 flex items-center gap-2">
            <span className="w-4 h-px bg-surface-600" />
            {label}
            <span className="flex-1 h-px bg-surface-600" />
          </h3>
          <div className="space-y-3">{children}</div>
        </div>
      );

      return (
        <div className="flex-1 overflow-auto bg-surface-800 p-6">
          <div className="max-w-4xl mx-auto">
            {/* Header */}
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-xl font-semibold text-theme-primary">Session History</h2>
              <div className="flex items-center gap-3">
                <div className="relative">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"
                    className="absolute left-3 top-1/2 -translate-y-1/2 text-theme-muted">
                    <circle cx="11" cy="11" r="8" /><path d="M21 21l-4.35-4.35" />
                  </svg>
                  <input
                    type="text"
                    placeholder="Search sessions..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="w-64 bg-surface-700 border border-surface-600 rounded-lg px-4 py-2 pl-10 text-sm text-theme-primary placeholder-theme-muted focus:outline-none focus:ring-2 focus:ring-accent/50"
                  />
                </div>
                <button
                  onClick={onClose}
                  className="p-2 rounded-lg hover:bg-surface-700 text-theme-muted hover:text-theme-primary transition-colors"
                >
                  {Icons.close}
                </button>
              </div>
            </div>

            {grouped.today.length > 0 && (
              <DateGroup label="Today">
                {grouped.today.map(session => (
                  <SessionCard
                    key={session.id}
                    session={session}
                    isExpanded={expandedSessions.has(session.id)}
                    onToggle={() => onToggleSession(session.id)}
                  />
                ))}
              </DateGroup>
            )}

            {grouped.yesterday.length > 0 && (
              <DateGroup label="Yesterday">
                {grouped.yesterday.map(session => (
                  <SessionCard
                    key={session.id}
                    session={session}
                    isExpanded={expandedSessions.has(session.id)}
                    onToggle={() => onToggleSession(session.id)}
                  />
                ))}
              </DateGroup>
            )}

            {grouped.older.length > 0 && (
              <DateGroup label="Older">
                {grouped.older.map(session => (
                  <SessionCard
                    key={session.id}
                    session={session}
                    isExpanded={expandedSessions.has(session.id)}
                    onToggle={() => onToggleSession(session.id)}
                  />
                ))}
              </DateGroup>
            )}

            {filteredSessions.length === 0 && (
              <div className="text-center py-12 text-theme-muted">
                <svg className="w-12 h-12 mx-auto mb-3 opacity-50" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
                  <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p className="text-sm">{searchQuery ? `No sessions found for "${searchQuery}"` : 'No session history yet'}</p>
              </div>
            )}
          </div>
        </div>
      );
    };

    // Main App
    const App = () => {
      const [instances, setInstances] = useState(mockInstances);
      const [activeInstance, setActiveInstance] = useState('1');
      const [selectedPlanId, setSelectedPlanId] = useState('plan-1');
      const [editorPanelOpen, setEditorPanelOpen] = useState(true);
      const [fullScreenPlan, setFullScreenPlan] = useState(null);
      const [panelWidth, setPanelWidth] = useState(380);
      const [browserHeight, setBrowserHeight] = useState(180);
      const [layout, setLayout] = useState('tabs');
      const [isDark, setIsDark] = useState(false);
      const [expandedSessions, setExpandedSessions] = useState(new Set());

      // View state: 'home', 'instances', or 'history'
      const [currentView, setCurrentView] = useState('home');

      // Welcome banner visibility
      const [showWelcome, setShowWelcome] = useState(() => {
        if (typeof window !== 'undefined') {
          return localStorage.getItem('cc-welcome-dismissed') !== 'true';
        }
        return true;
      });

      const dismissWelcome = () => {
        setShowWelcome(false);
        localStorage.setItem('cc-welcome-dismissed', 'true');
      };

      // Focus mode state
      const [focusedInstance, setFocusedInstance] = useState(null);

      // Editable name state
      const [editingInstanceId, setEditingInstanceId] = useState(null);
      const [editingName, setEditingName] = useState('');

      // Close confirmation state
      const [closeConfirmation, setCloseConfirmation] = useState(null);

      // Shortcuts modal state
      const [showShortcuts, setShowShortcuts] = useState(false);

      // Apply theme
      useEffect(() => {
        document.documentElement.classList.toggle('dark', isDark);
        document.body.classList.toggle('dark', isDark);
      }, [isDark]);

      // Keyboard handlers for focus mode and tab switching
      useEffect(() => {
        const handleKeyDown = (e) => {
          // Don't handle keys when editing an instance name
          if (editingInstanceId) {
            if (e.key === 'Escape') {
              cancelEditing();
            }
            return;
          }

          // Escape: close shortcuts modal, exit focus mode
          if (e.key === 'Escape') {
            if (showShortcuts) {
              setShowShortcuts(false);
              return;
            }
            if (focusedInstance) {
              setFocusedInstance(null);
              return;
            }
          }

          // Cmd/Ctrl + ? or / : open keyboard shortcuts modal
          if ((e.metaKey || e.ctrlKey) && (e.key === '?' || e.key === '/')) {
            e.preventDefault();
            setShowShortcuts(true);
            return;
          }

          // Enter: enter focus mode
          if (e.key === 'Enter' && activeInstance && !focusedInstance && currentView === 'instances') {
            setFocusedInstance(activeInstance);
            return;
          }

          // F2: start renaming active instance
          if (e.key === 'F2' && activeInstance && currentView === 'instances') {
            e.preventDefault();
            const inst = instances.find(i => i.id === activeInstance);
            if (inst) startEditing(inst.id, inst.name);
            return;
          }

          // Cmd/Ctrl + 1-9: switch to tab
          if ((e.metaKey || e.ctrlKey) && e.key >= '1' && e.key <= '9') {
            e.preventDefault();
            const index = parseInt(e.key) - 1;
            if (index < sortedInstances.length) {
              setActiveInstance(sortedInstances[index].id);
              setCurrentView('instances');
            }
            return;
          }

          // Cmd/Ctrl + [ : previous tab
          if ((e.metaKey || e.ctrlKey) && e.key === '[') {
            e.preventDefault();
            const currentIndex = sortedInstances.findIndex(i => i.id === activeInstance);
            if (currentIndex > 0) {
              setActiveInstance(sortedInstances[currentIndex - 1].id);
              setCurrentView('instances');
            } else if (sortedInstances.length > 0) {
              // Wrap to last
              setActiveInstance(sortedInstances[sortedInstances.length - 1].id);
              setCurrentView('instances');
            }
            return;
          }

          // Cmd/Ctrl + ] : next tab
          if ((e.metaKey || e.ctrlKey) && e.key === ']') {
            e.preventDefault();
            const currentIndex = sortedInstances.findIndex(i => i.id === activeInstance);
            if (currentIndex < sortedInstances.length - 1) {
              setActiveInstance(sortedInstances[currentIndex + 1].id);
              setCurrentView('instances');
            } else if (sortedInstances.length > 0) {
              // Wrap to first
              setActiveInstance(sortedInstances[0].id);
              setCurrentView('instances');
            }
            return;
          }

          // Cmd/Ctrl + E: toggle plans panel
          if ((e.metaKey || e.ctrlKey) && e.key === 'e' && !e.shiftKey) {
            e.preventDefault();
            setEditorPanelOpen(prev => !prev);
            return;
          }

          // Cmd/Ctrl + W: close active instance
          if ((e.metaKey || e.ctrlKey) && e.key === 'w' && currentView === 'instances') {
            e.preventDefault();
            if (activeInst) requestClose(activeInst);
            return;
          }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, [focusedInstance, activeInstance, editingInstanceId, currentView, instances, sortedInstances, activeInst, showShortcuts]);

      const activeInst = instances.find(i => i.id === activeInstance);
      const plansForActiveInstance = activeInst?.hasPlansDir ? mockPlansByDir[activeInst.workingDir] : null;
      const selectedPlan = plansForActiveInstance?.find(p => p.id === selectedPlanId);

      // Sort instances with pinned first
      const sortedInstances = [...instances].sort((a, b) => {
        if (a.pinned && !b.pinned) return -1;
        if (!a.pinned && b.pinned) return 1;
        return 0;
      });

      // Handle double-click to focus
      const handleDoubleClickInstance = (instanceId) => {
        if (focusedInstance === instanceId) {
          setFocusedInstance(null);
        } else {
          setFocusedInstance(instanceId);
        }
      };

      // Exit focus mode
      const exitFocusMode = () => setFocusedInstance(null);

      // Switch focus to another instance
      const switchFocus = (instanceId) => {
        setActiveInstance(instanceId);
        setFocusedInstance(instanceId);
      };

      // Start editing an instance name
      const startEditing = (instanceId, currentName) => {
        setEditingInstanceId(instanceId);
        setEditingName(currentName);
      };

      // Cancel editing
      const cancelEditing = () => {
        setEditingInstanceId(null);
        setEditingName('');
      };

      // Validate and confirm rename
      const confirmRename = (instanceId) => {
        const trimmedName = editingName.trim();
        if (trimmedName && /^[a-zA-Z0-9_-]+$/.test(trimmedName)) {
          setInstances(prev => prev.map(inst =>
            inst.id === instanceId ? { ...inst, name: trimmedName } : inst
          ));
        }
        cancelEditing();
      };

      const handleTogglePin = (id) => {
        setInstances(prev => prev.map(inst =>
          inst.id === id ? { ...inst, pinned: !inst.pinned } : inst
        ));
      };

      // Request to close (may show confirmation)
      const requestClose = (instance) => {
        const needsConfirmation =
          instance.status === 'working' ||
          instance.status === 'awaiting' ||
          instance.status === 'error' ||
          instance.pinned;

        if (needsConfirmation) {
          setCloseConfirmation(instance);
        } else {
          handleCloseInstance(instance.id);
        }
      };

      // Actually close the instance
      const handleCloseInstance = (instanceId) => {
        const instanceIndex = instances.findIndex(i => i.id === instanceId);
        const wasActive = activeInstance === instanceId;

        setInstances(prev => {
          const remaining = prev.filter(i => i.id !== instanceId);
          if (wasActive && remaining.length > 0) {
            const newActiveIndex = Math.max(0, instanceIndex - 1);
            setActiveInstance(remaining[Math.min(newActiveIndex, remaining.length - 1)].id);
          } else if (remaining.length === 0) {
            setActiveInstance(null);
          }
          return remaining;
        });
      };

      // Confirm close from dialog
      const confirmClose = () => {
        if (closeConfirmation) {
          handleCloseInstance(closeConfirmation.id);
          setCloseConfirmation(null);
        }
      };

      // Cancel close dialog
      const cancelClose = () => setCloseConfirmation(null);

      // Reorder instances (drag and drop)
      const handleReorder = (draggedId, targetId) => {
        setInstances(prev => {
          const newInstances = [...prev];
          const draggedIndex = newInstances.findIndex(i => i.id === draggedId);
          const targetIndex = newInstances.findIndex(i => i.id === targetId);
          const [removed] = newInstances.splice(draggedIndex, 1);
          newInstances.splice(targetIndex, 0, removed);
          return newInstances;
        });
      };

      // Duplicate an instance
      const handleDuplicate = (instanceId) => {
        const instance = instances.find(i => i.id === instanceId);
        if (!instance) return;

        const newInstance = {
          ...instance,
          id: `${instance.id}-copy-${Date.now()}`,
          name: `${instance.name}-copy`,
          pinned: false,
          status: 'idle',
        };
        setInstances(prev => [...prev, newInstance]);
        setActiveInstance(newInstance.id);
      };

      // Close all instances except one
      const handleCloseOthers = (keepId) => {
        const keep = instances.find(i => i.id === keepId);
        if (keep) {
          setInstances([keep]);
          setActiveInstance(keepId);
        }
      };

      // Close all instances to the right
      const handleCloseRight = (fromId) => {
        const fromIndex = instances.findIndex(i => i.id === fromId);
        if (fromIndex >= 0) {
          setInstances(prev => prev.slice(0, fromIndex + 1));
        }
      };

      const handleNewPlan = () => {
        alert('Create new plan in: ' + activeInst?.workingDir + '/plans/');
      };

      const handleInject = () => {
        alert(`Injecting plan "${selectedPlan?.name}" into terminal: ${activeInst?.name}`);
      };

      const handleToggleSession = (sessionId) => {
        setExpandedSessions(prev => {
          const next = new Set(prev);
          if (next.has(sessionId)) next.delete(sessionId);
          else next.add(sessionId);
          return next;
        });
      };

      // Panel resize
      const handlePanelResizeStart = (e) => {
        e.preventDefault();
        const startX = e.clientX;
        const startWidth = panelWidth;

        const handleMouseMove = (e) => {
          const diff = startX - e.clientX;
          setPanelWidth(Math.max(280, Math.min(600, startWidth + diff)));
        };

        const handleMouseUp = () => {
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
        };

        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
      };

      // Browser resize (vertical)
      const handleBrowserResizeStart = (e) => {
        e.preventDefault();
        const startY = e.clientY;
        const startHeight = browserHeight;

        const handleMouseMove = (e) => {
          const diff = e.clientY - startY;
          setBrowserHeight(Math.max(100, Math.min(400, startHeight + diff)));
        };

        const handleMouseUp = () => {
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
        };

        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
      };

      return (
        <div className="h-screen flex flex-col bg-atmosphere">
          {/* Header */}
          <header className="flex items-center justify-between px-4 py-3 bg-surface-800 border-b border-surface-600">
            <div className="flex items-center gap-4">
              <h1
                className="text-xl font-bold tracking-tight text-theme-primary cursor-pointer hover:text-accent transition-colors"
                onClick={() => setCurrentView('home')}
                title="Go to Home"
              >
                <span className="text-accent font-extrabold">CC</span> Orchestrator
              </h1>
              <div className="text-xs text-theme-muted font-mono">
                {instances.length} instances
                {instances.filter(i => i.pinned).length > 0 && (
                  <span className="ml-2 text-accent">
                    ({instances.filter(i => i.pinned).length} pinned)
                  </span>
                )}
              </div>
            </div>
            <div className="flex items-center gap-3">
              <Tooltip
                text={currentView !== 'instances' || layout === 'cards' ? 'Plans available in Tabs/List view' : (editorPanelOpen ? 'Hide plans' : 'Show plans')}
                position="bottom"
              >
                <button
                  onClick={() => currentView === 'instances' && layout !== 'cards' && setEditorPanelOpen(!editorPanelOpen)}
                  className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors
                    ${currentView !== 'instances' || layout === 'cards'
                      ? 'text-theme-dim cursor-not-allowed'
                      : editorPanelOpen
                        ? 'bg-accent text-surface-900'
                        : 'text-theme-muted hover:text-theme-primary hover:bg-surface-700'}`}
                >
                  {Icons.file}
                  <span>Plans</span>
                </button>
              </Tooltip>
              <Tooltip text={currentView === 'history' ? 'Close history' : 'View history'} position="bottom">
                <button
                  onClick={() => setCurrentView(currentView === 'history' ? 'instances' : 'history')}
                  className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors
                    ${currentView === 'history'
                      ? 'bg-accent text-surface-900'
                      : 'text-theme-muted hover:text-theme-primary hover:bg-surface-700'}`}
                >
                  {Icons.history}
                  <span className="hidden sm:inline">History</span>
                </button>
              </Tooltip>
              <LayoutSwitcher layout={layout} onChange={(newLayout) => {
                setLayout(newLayout);
                setCurrentView('instances'); // Exit home/history when switching layouts
              }} />
              <ThemeToggle isDark={isDark} onToggle={() => setIsDark(!isDark)} />
              <Tooltip text="Keyboard shortcuts (⌘?)" position="bottom">
                <button
                  onClick={() => setShowShortcuts(true)}
                  className="p-2 rounded-lg text-theme-muted hover:text-theme-primary hover:bg-surface-700 transition-colors"
                >
                  <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                    <circle cx="12" cy="17" r="0.5" fill="currentColor"/>
                  </svg>
                </button>
              </Tooltip>
            </div>
          </header>

          {/* Main content */}
          <div className="flex-1 flex overflow-hidden">
            {currentView === 'history' ? (
              /* History View */
              <HistoryView
                sessions={mockSessions}
                expandedSessions={expandedSessions}
                onToggleSession={handleToggleSession}
                onClose={() => setCurrentView('instances')}
              />
            ) : currentView === 'home' ? (
              /* Home Page */
              <HomePage
                instances={instances}
                showWelcome={showWelcome}
                onDismissWelcome={dismissWelcome}
                onNewInstance={() => {
                  // TODO: implement new instance creation
                  setCurrentView('instances');
                }}
                onViewAll={() => setCurrentView('instances')}
                onSelectInstance={(id) => {
                  setActiveInstance(id);
                  setCurrentView('instances');
                }}
              />
            ) : (
              <>
                <div className="flex-1 flex flex-col overflow-hidden">
                  {/* Layout-specific content */}
                  {layout === 'tabs' && (
                    <>
                      <TabBar
                        instances={sortedInstances}
                        activeId={activeInstance}
                        onSelect={setActiveInstance}
                        onTogglePin={handleTogglePin}
                        onClose={requestClose}
                        onDoubleClick={handleDoubleClickInstance}
                        onExpand={(id) => setFocusedInstance(id)}
                        onReorder={handleReorder}
                        onDuplicate={handleDuplicate}
                        onCloseOthers={handleCloseOthers}
                        onCloseRight={handleCloseRight}
                        editingInstanceId={editingInstanceId}
                        editingName={editingName}
                        onStartEditing={startEditing}
                        onEditingNameChange={setEditingName}
                        onConfirmRename={confirmRename}
                        onCancelEditing={cancelEditing}
                      />
                      {activeInst && (
                        <TerminalView
                          instance={activeInst}
                          editingInstanceId={editingInstanceId}
                          editingName={editingName}
                          onStartEditing={startEditing}
                          onEditingNameChange={setEditingName}
                          onConfirmRename={confirmRename}
                          onCancelEditing={cancelEditing}
                        />
                      )}
                    </>
                  )}
                  {layout === 'cards' && (
                    <div className="flex-1 overflow-auto bg-surface-800">
                      <CardLayout
                        instances={sortedInstances}
                        activeId={activeInstance}
                        onSelect={setActiveInstance}
                        onTogglePin={handleTogglePin}
                        onClose={requestClose}
                        onDoubleClick={handleDoubleClickInstance}
                        onExpand={(id) => setFocusedInstance(id)}
                        onReorder={handleReorder}
                        editingInstanceId={editingInstanceId}
                        editingName={editingName}
                        onStartEditing={startEditing}
                        onEditingNameChange={setEditingName}
                        onConfirmRename={confirmRename}
                        onCancelEditing={cancelEditing}
                      />
                    </div>
                  )}
                  {layout === 'list' && (
                    <div className="flex-1 flex flex-col overflow-hidden bg-surface-800">
                      <div className="overflow-auto">
                        <ListLayout
                          instances={sortedInstances}
                          activeId={activeInstance}
                          onSelect={setActiveInstance}
                          onTogglePin={handleTogglePin}
                          onClose={requestClose}
                          onDoubleClick={handleDoubleClickInstance}
                          onExpand={(id) => setFocusedInstance(id)}
                          onReorder={handleReorder}
                          editingInstanceId={editingInstanceId}
                          editingName={editingName}
                          onStartEditing={startEditing}
                          onEditingNameChange={setEditingName}
                          onConfirmRename={confirmRename}
                          onCancelEditing={cancelEditing}
                        />
                      </div>
                      {activeInst && (
                        <div className="border-t border-surface-600 flex-1">
                          <TerminalView
                            instance={activeInst}
                            editingInstanceId={editingInstanceId}
                            editingName={editingName}
                            onStartEditing={startEditing}
                            onEditingNameChange={setEditingName}
                            onConfirmRename={confirmRename}
                            onCancelEditing={cancelEditing}
                          />
                        </div>
                      )}
                    </div>
                  )}
                </div>

                {/* Resize handle - only show when terminal is visible (tabs or list layout) */}
                {editorPanelOpen && layout !== 'cards' && (
                  <div className="resize-handle-h" onMouseDown={handlePanelResizeStart} />
                )}

                {/* Editor panel - only show when viewing a terminal (not in cards overview) */}
                {editorPanelOpen && activeInst && layout !== 'cards' && (
                  <div className="slide-in flex flex-col" style={{ width: panelWidth }}>
                    <EditorPanel
                      plans={plansForActiveInstance}
                      selectedPlanId={selectedPlanId}
                      instance={activeInst}
                      onSelectPlan={setSelectedPlanId}
                      onNewPlan={handleNewPlan}
                      onExpandEditor={() => selectedPlan && setFullScreenPlan(selectedPlan)}
                      onInject={handleInject}
                      browserHeight={browserHeight}
                      onBrowserResizeStart={handleBrowserResizeStart}
                    />
                  </div>
                )}
              </>
            )}
          </div>

          {/* Focus Mode Overlay */}
          {focusedInstance && instances.find(i => i.id === focusedInstance) && (
            <FocusOverlay onClick={exitFocusMode}>
              {/* Focused Terminal (main area) */}
              <div className="flex-1 p-6 flex">
                <FocusedTerminalView
                  instance={instances.find(i => i.id === focusedInstance)}
                  onCollapse={exitFocusMode}
                  editingInstanceId={editingInstanceId}
                  editingName={editingName}
                  onStartEditing={startEditing}
                  onEditingNameChange={setEditingName}
                  onConfirmRename={confirmRename}
                  onCancelEditing={cancelEditing}
                />
              </div>

              {/* Thumbnail Sidebar */}
              {instances.length > 1 && (
                <div className="w-64 bg-surface-800 border-l border-surface-600 p-4 flex flex-col gap-2 overflow-auto">
                  <div className="text-xs text-gray-500 font-medium mb-2">Other Instances</div>
                  {sortedInstances
                    .filter(i => i.id !== focusedInstance)
                    .map(instance => (
                      <ThumbnailInstance
                        key={instance.id}
                        instance={instance}
                        isActive={instance.id === activeInstance}
                        onClick={() => switchFocus(instance.id)}
                      />
                    ))}
                </div>
              )}
            </FocusOverlay>
          )}

          {/* Full-screen editor */}
          {fullScreenPlan && (
            <FullScreenEditor
              plan={fullScreenPlan}
              onClose={() => setFullScreenPlan(null)}
              onInject={handleInject}
            />
          )}

          {/* Confirmation Dialog */}
          <ConfirmDialog
            isOpen={closeConfirmation !== null}
            instance={closeConfirmation}
            onConfirm={confirmClose}
            onCancel={cancelClose}
          />

          {/* Keyboard Shortcuts Modal */}
          <ShortcutsModal
            isOpen={showShortcuts}
            onClose={() => setShowShortcuts(false)}
          />
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
