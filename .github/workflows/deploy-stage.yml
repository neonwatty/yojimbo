name: Deploy to Staging

on:
  push:
    branches: [stage]
  workflow_dispatch: # Allow manual trigger from GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.MAC_MINI_STAGING_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          # Add Mac mini to known hosts (will be populated on first connect)
          ssh-keyscan -H ${{ secrets.MAC_MINI_STAGING_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to Mac Mini (Staging)
        env:
          MAC_MINI_USER: ${{ secrets.MAC_MINI_STAGING_USER }}
          MAC_MINI_HOST: ${{ secrets.MAC_MINI_STAGING_HOST }}
        run: |
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 ${MAC_MINI_USER}@${MAC_MINI_HOST} << 'DEPLOY'
            set -e

            # Source nvm
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            nvm use 20

            echo "========================================"
            echo "ðŸŽ­ Starting STAGING deployment..."
            echo "========================================"

            cd ~/yojimbo

            echo ""
            echo "ðŸ“¥ Pulling latest changes..."
            git fetch origin stage
            git reset --hard origin/stage

            echo ""
            echo "ðŸ“¦ Installing dependencies..."
            npm ci

            echo ""
            echo "ðŸ”¨ Building application..."
            npm run build

            echo ""
            echo "ðŸ“ Creating logs directory..."
            mkdir -p logs

            echo ""
            echo "ðŸ”„ Restarting services..."
            if pm2 describe yojimbo-staging > /dev/null 2>&1; then
              # Zero-downtime reload using ecosystem config
              pm2 reload ecosystem.config.cjs
            else
              # First-time setup
              pm2 start ecosystem.config.cjs
              pm2 save
            fi

            echo ""
            echo "========================================"
            echo "âœ… STAGING Deployment complete!"
            echo "========================================"
            pm2 status yojimbo-staging
          DEPLOY

      - name: Deployment Summary
        if: success()
        run: |
          echo "## ðŸŽ­ Staging Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed to:** Mac Mini (Staging) via Tailscale" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** stage" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: Deployment Failed
        if: failure()
        run: |
          echo "## âŒ Staging Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
